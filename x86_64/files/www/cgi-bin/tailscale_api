#!/bin/sh
echo "Content-type: application/json"
echo ""

TS="/bin/tailscale"

case "$QUERY_STRING" in
    *action=status*)
        ST=$($TS status --json 2>/dev/null)
        ACTIVE=$(echo "$ST" | jq -r '.BackendState // "未运行"')
        if [ "$ACTIVE" != "Running" ]; then
            # 去掉 --reset 以避免每次刷新都重置状态
            URL=$($TS up --accept-dns=false 2>&1 | grep -o 'https://login.tailscale.com/a/[^ ]*')
            echo "{\"active\": \"未登录\", \"url\": \"$URL\", \"devices\": []}"
        else
            IP=$(echo "$ST" | jq -r '.Self.TailscaleIPs[0] // "-"')
            DEVICES=$(echo "$ST" | jq -c '.Peer | to_entries | map({hostname: .value.HostName, ip: (.value.TailscaleIPs[0] // "-"), online: .value.Online})')
            echo "{\"active\": \"运行中\", \"ip\": \"$IP\", \"devices\": $DEVICES}"
        fi
        ;;
    *action=logout*)
        $TS logout >/dev/null 2>&1
        echo "{\"result\": \"ok\"}"
        ;;
esac
