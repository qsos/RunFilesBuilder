<%+header%>

<div class="cbi-map">
    <h2 style="margin-bottom:20px">Tailscale 控制面板</h2>

    <div style="background:#ffffff; padding:15px; border:1px solid #dddddd; border-radius:4px;">
        <p>
            <strong>状态：</strong>
            <span id="st-txt">检测中...</span>
        </p>
        <p>
            <strong>IP：</strong>
            <span id="ip-txt">-</span>
        </p>

        <button
            type="button"
            class="cbi-button"
            onclick="loginTS()">
            登录 Tailscale
        </button>

        <button
            type="button"
            class="cbi-button-negative"
            onclick="logoutTS()"
            style="margin-left:10px">
            注销
        </button>
    </div>
</div>

<script type="text/javascript">
function refresh() {
    fetch('/cgi-bin/tailscale_api?action=status')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            document.getElementById('st-txt').innerText = d.active || '-';
            document.getElementById('st-txt').style.color =
                (d.active === '运行中') ? 'green' : 'red';
            document.getElementById('ip-txt').innerText = d.ip || '-';
        })
        .catch(function() {
            document.getElementById('st-txt').innerText = '接口错误';
            document.getElementById('st-txt').style.color = 'red';
        });
}

function loginTS() {
    window.open('https://login.tailscale.com/a/console', '_blank');
    fetch('/cgi-bin/tailscale_api?action=login');
    setTimeout(refresh, 3000);
}

function logoutTS() {
    fetch('/cgi-bin/tailscale_api?action=logout');
    setTimeout(refresh, 2000);
}

refresh();
setInterval(refresh, 5000);
</script>

<%+footer%>
