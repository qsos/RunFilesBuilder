#=================================================
# Build Tailscale GUI RunFiles
# Based on https://github.com/wukongdaily/RunFilesBuilder
#=================================================
name: Make Tailscale GUI run files

on:
  workflow_dispatch:

jobs:
  make-run:
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: sudo apt-get update && sudo apt-get install -y makeself curl tar

      - name: ğŸš€ ä¸‹è½½ tailscale + LuCI GUI
        run: |
          set -e
          VERSION="1.92.1"

          mkdir -p x86_64
          cd x86_64

          echo "â¬‡ï¸ ä¸‹è½½ tailscale ${VERSION}"
          curl -fL \
            https://github.com/tailscale/tailscale/releases/download/v${VERSION}/tailscale_${VERSION}_amd64.tgz \
            -o tailscale.tgz

          tar zxvf tailscale.tgz
          mv tailscale_${VERSION}_amd64/tailscale .
          mv tailscale_${VERSION}_amd64/tailscaled .

          chmod +x tailscale tailscaled
          rm -rf tailscale_${VERSION}_amd64 tailscale.tgz

          echo "â¬‡ï¸ ä¸‹è½½ LuCI tailscale æ’ä»¶"
          curl -fL \
            https://github.com/asvow/luci-app-tailscale/releases/download/v1.0.0/luci-app-tailscale_all.ipk \
            -o luci-app-tailscale.ipk

      - name: ğŸ“‹ æ”¾ç½® install.sh
        run: |
          cp shell/install.sh x86_64/install.sh
          chmod +x x86_64/install.sh

      - name: ğŸ“¦ æ‰“åŒ… run æ–‡ä»¶
        run: |
          mkdir -p output
          makeself x86_64 \
            output/tailscale-gui-1.92.1_x86_64.run \
            "Tailscale GUI Installer (x86_64)" \
            ./install.sh

      - name: ğŸ“¤ ä¸Šä¼  Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "tailscale-gui-1.92.1"
          name: "tailscale-gui-1.92.1"
          files: output/*.run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
