name: Build Tailscale iStoreOS Style Console

on:
  workflow_dispatch:
    inputs:
      version:
        description: '指定版本 (留空则自动获取最新)'
        required: false
        default: ''
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    strategy:
      matrix:
        include:
          - arch: amd64
            output_name: x86
          - arch: arm64
            output_name: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Tools
        run: sudo apt-get update && sudo apt-get install -y makeself jq curl

      - name: Determine Version
        id: meta
        run: |
          if [ -z "${{ github.event.inputs.version }}" ]; then
            VERSION=$(curl -sL https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r ".tag_name" | sed 's/v//')
          else
            VERSION=${{ github.event.inputs.version }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download and Prepare Staging
        run: |
          VERSION=${{ steps.meta.outputs.version }}
          curl -fSL "https://pkgs.tailscale.com/stable/tailscale_${VERSION}_${{ matrix.arch }}.tgz" -o tailscale.tgz
          tar xzf tailscale.tgz
          mkdir -p staging/bin staging/usr/lib/lua/luci/controller/ staging/usr/lib/lua/luci/view/tailscale_web/ staging/www/cgi-bin/
          mv tailscale_*/tailscale staging/bin/
          mv tailscale_*/tailscaled staging/bin/
          rm -rf tailscale.tgz tailscale_*

      - name: Create Backend API
        run: |
          cat << 'EOF' > staging/www/cgi-bin/tailscale_api
          #!/bin/sh
          echo "Content-type: application/json"
          echo ""
          case "$QUERY_STRING" in
              *action=status*)
                  ST=$(/usr/sbin/tailscale status --json 2>/dev/null)
                  if [ $? -ne 0 ]; then
                      echo "{\"active\": \"Stopped\"}"
                  else
                      USER=$(echo "$ST" | jq -r '.Self.User')
                      MAIL=$(echo "$ST" | jq -r ".User[\"$USER\"].LoginName // \"未登录\"")
                      IP=$(echo "$ST" | jq -r '.Self.TailscaleIPs[0]')
                      DEVICES=$(echo "$ST" | jq -c '.Peer | to_entries | map({
                          hostname: .value.HostName,
                          ip: .value.TailscaleIPs[0],
                          os: .value.OS,
                          version: .value.Version,
                          online: .value.Online,
                          expiry: (if .value.KeyExpiryDisabled then "disabled" else "enabled" end)
                      })')
                      echo "{\"active\": \"Running\", \"ip\": \"$IP\", \"mail\": \"$MAIL\", \"devices\": $DEVICES}"
                  fi
                  ;;
              *action=login*)
                  /usr/sbin/tailscale up --accept-dns=false --reset >/dev/null 2>&1 &
                  echo "{\"result\": \"success\"}"
                  ;;
              *action=logout*)
                  /usr/sbin/tailscale logout >/dev/null 2>&1
                  echo "{\"result\": \"success\"}"
                  ;;
              *action=subnet_on*)
                  LAN=$(uci get network.lan.ipaddr | cut -d. -f1-3).0/24
                  /usr/sbin/tailscale up --advertise-routes=$LAN --reset >/dev/null 2>&1 &
                  echo "{\"result\": \"success\"}"
                  ;;
              *action=subnet_off*)
                  /usr/sbin/tailscale up --advertise-routes= --reset >/dev/null 2>&1 &
                  echo "{\"result\": \"success\"}"
                  ;;
              *action=expiry_toggle*)
                  /usr/sbin/tailscale up --reset-node-key >/dev/null 2>&1 &
                  echo "{\"result\": \"success\"}"
                  ;;
          esac
          EOF
          chmod 755 staging/www/cgi-bin/tailscale_api

      - name: Create Console UI (iStoreOS Style)
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/view/tailscale_web/index.htm
          <%+header%>
          <style>
              .ts-info-bar { margin-bottom: 15px; padding: 10px; background: #f4f4f4; border: 1px solid #ddd; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
              .status-on { color: green; font-weight: bold; }
              .status-off { color: #999; }
              .m-mail { color: #666; font-size: 0.9em; display: block; }
              .tag { background: #eee; padding: 1px 4px; border-radius: 3px; font-size: 11px; color: #666; margin-right: 4px; border: 1px solid #ccc; }
              .tag-blue { background: #e6f7ff; color: #1890ff; border-color: #91d5ff; }
              .drop-btn { cursor: pointer; padding: 2px 8px; border: 1px solid #ccc; background: #fff; border-radius: 4px; }
              .drop-menu { display: none; position: absolute; background: #fff; min-width: 150px; border: 1px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 999; right: 20px; }
              .drop-menu a { display: block; padding: 8px 12px; text-decoration: none; color: #333; font-size: 13px; border-bottom: 1px solid #eee; }
              .drop-menu a:hover { background: #f0f0f0; }
              .show { display: block; }
          </style>

          <div class="cbi-map">
              <h2 name="content">Tailscale 交互控制台</h2>
              
              <div class="ts-info-bar">
                  <div>
                      <strong>当前账号:</strong> <span id="self-mail">加载中...</span>
                      <span id="self-ip" style="margin-left:15px; color:#666;">IP: -</span>
                  </div>
                  <div>
                      <button class="cbi-button cbi-button-apply" onclick="doAct('login')">登录</button>
                      <button class="cbi-button cbi-button-reset" onclick="doAct('logout')">注销</button>
                  </div>
              </div>

              <div id="login-link-box" style="display:none; padding:10px; background:#fffbe6; border:1px solid #ffe58f; margin-bottom:15px;">
                  ⚠️ 需授权: <a id="ts-url" href="#" target="_blank" style="font-weight:bold;">点击登录</a>
              </div>

              <fieldset class="cbi-section">
                  <legend>设备列表</legend>
                  <table class="cbi-section-table" id="dev-table">
                      <tr class="cbi-section-table-titles">
                          <th class="cbi-section-table-cell">MACHINE</th>
                          <th class="cbi-section-table-cell">ADDRESSES</th>
                          <th class="cbi-section-table-cell">VERSION</th>
                          <th class="cbi-section-table-cell">LAST SEEN</th>
                          <th class="cbi-section-table-cell"></th>
                      </tr>
                  </table>
              </fieldset>
          </div>

          <script>
              function refresh() {
                  fetch('/cgi-bin/tailscale_api?action=status').then(r => r.json()).then(d => {
                      document.getElementById('self-mail').innerText = d.mail || "未登录";
                      document.getElementById('self-ip').innerText =
