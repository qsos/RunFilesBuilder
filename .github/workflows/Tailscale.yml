#=================================================
# Build Tailscale GUI RunFiles (Auto Latest Stable)
#=================================================
name: Make Tailscale GUI run files (Auto Latest)

on:
  workflow_dispatch:

jobs:
  make-run:
    runs-on: ubuntu-22.04

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ðŸ“¦ Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y makeself curl jq

      - name: ðŸš€ Prepare x86_64 payload
        run: |
          set -e

          mkdir -p x86_64
          cd x86_64

          echo "ðŸ” Fetching latest Tailscale stable version"
          VERSION=$(curl -fsSL https://pkgs.tailscale.com/stable/?mode=json | jq -r '.Version')

          if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
            echo "âŒ Failed to get Tailscale version"
            exit 1
          fi

          echo "âž¡ Latest stable version: $VERSION"

          echo "â¬‡ï¸ Downloading tailscale core"
          curl -fL \
            https://pkgs.tailscale.com/stable/tailscale_${VERSION}_amd64.tgz \
            -o tailscale.tgz

          tar zxf tailscale.tgz
          mv tailscale_${VERSION}_amd64/tailscale .
          mv tailscale_${VERSION}_amd64/tailscaled .

          chmod +x tailscale tailscaled
          rm -rf tailscale_${VERSION}_amd64 tailscale.tgz

          echo "â¬‡ï¸ Downloading LuCI Tailscale Community GUI"
          curl -fL \
            https://dl.openwrt.ai/packages-24.10/x86_64/kiddin9/luci-app-tailscale-community_26.341.56069~77a6686_all.ipk \
            -o luci-app-tailscale-community.ipk

          echo "$VERSION" > VERSION

      - name: ðŸ“‹ Copy install script
        run: |
          cp shell/install.sh x86_64/install.sh
          chmod +x x86_64/install.sh

      - name: ðŸ“¦ Build .run installer
        run: |
          VERSION=$(cat x86_64/VERSION)
          mkdir -p output
          makeself x86_64 \
            output/tailscale-gui-community_${VERSION}_x86_64.run \
            "Tailscale GUI Community Installer ${VERSION} (x86_64)" \
            ./install.sh

      - name: ðŸ“¤ Upload release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "tailscale-${{ github.run_number }}"
          name: "Tailscale GUI Auto Latest"
          files: output/*.run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
