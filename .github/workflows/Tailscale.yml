name: Build Tailscale RUN (iStoreOS GUI)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install build tools
        run: |
          sudo apt-get update
          sudo apt-get install -y curl tar makeself

      - name: Prepare directories
        run: |
          mkdir -p x86_64
          mkdir -p output

      - name: Download Tailscale core & LuCI GUI
        run: |
          set -e
          cd x86_64

          BASE_URL="https://dl.openwrt.ai/packages-24.10/x86_64/kiddin9"

          echo "⬇️ Download tailscale core"
          curl -LO ${BASE_URL}/tailscale_1.92.3-1_x86_64.ipk

          echo "⬇️ Download luci GUI"
          curl -LO ${BASE_URL}/luci-app-tailscale-community_26.341.56069~77a6686_all.ipk

      - name: Copy install script
        run: |
          cp shell/install-tailscale.sh x86_64/install-tailscale.sh
          chmod +x x86_64/install-tailscale.sh

      - name: Build .run package
        run: |
          VERSION=1.92.3
          makeself x86_64 \
            output/tailscale-gui-${VERSION}-x86_64.run \
            "Tailscale GUI Installer for iStoreOS ${VERSION}" \
            ./install-tailscale.sh

      - name: Upload .run artifact
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-run
          path: output/*.run
