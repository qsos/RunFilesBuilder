name: Build Tailscale .run (x86 & arm64 + Simple GUI)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Tailscale Version (ç•™ç©ºè‡ªåŠ¨æœ€æ–°)'
        required: false
        default: ''
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            output_name: x86
          - arch: arm64
            output_name: arm64

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y makeself jq curl

      - name: Determine Version
        id: meta
        run: |
          if [ -z "${{ inputs.version }}" ]; then
            TAG=$(curl -sL https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r ".tag_name")
            VERSION=${TAG#v}
          else
            VERSION=${{ inputs.version }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download Official Binaries
        run: |
          VERSION=${{ steps.meta.outputs.version }}
          DL_ARCH=${{ matrix.arch }}
          curl -fSL "https://pkgs.tailscale.com/stable/tailscale_${VERSION}_${DL_ARCH}.tgz" -o tailscale.tgz
          tar xzf tailscale.tgz
          
          mkdir -p staging/bin
          mkdir -p staging/usr/lib/lua/luci/controller/
          mkdir -p staging/usr/lib/lua/luci/view/tailscale_web/
          
          EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "tailscale_*_${DL_ARCH}" | head -n 1)
          mv "$EXTRACTED_DIR/tailscale" staging/bin/
          mv "$EXTRACTED_DIR/tailscaled" staging/bin/
          rm -rf "$EXTRACTED_DIR" tailscale.tgz

      - name: Generate LuCI Files
        run: |
          # 1. ç”Ÿæˆæ§åˆ¶å™¨
          cat << 'EOF' > staging/usr/lib/lua/luci/controller/tailscale_web.lua
          module("luci.controller.tailscale_web", package.seeall)
          function index()
              entry({"admin", "services", "tailscale_web"}, template("tailscale_web/index"), _("Tailscale Web"), 99).dependent = false
          end
          EOF

          # 2. ç”Ÿæˆè·³è½¬é¡µé¢
          cat << 'EOF' > staging/usr/lib/lua/luci/view/tailscale_web/index.htm
          <%+header%>
          <div class="cbi-map">
          <h2 name="content">Tailscale Web ç®¡ç†</h2>
          <fieldset class="cbi-section">
              <div style="text-align: center; margin: 30px 0;">
                  <input type="button" class="cbi-button cbi-button-apply important"
                         style="font-size: 1.3em; padding: 15px 40px; cursor: pointer;"
                         value="ğŸ‘‰ æ‰“å¼€ Tailscale Web ç•Œé¢ ğŸ‘ˆ"
                         onclick="window.open('http://' + window.location.hostname + ':5252', '_blank'); return false;" />
                  <p style="margin-top: 20px; color: #666;">æ³¨æ„ï¼šå¦‚æœæ— æ³•æ‰“å¼€ï¼Œè¯·ç¡®ä¿æ’ä»¶å·²æˆåŠŸå®‰è£…å¹¶å¯åŠ¨ã€‚</p>
              </div>
          </fieldset>
          </div>
          <%+footer%>
          EOF

      - name: Prepare Install Script
        run: |
          # å°†ä½ çš„è„šæœ¬å¤åˆ¶åˆ°æ‰“åŒ…ç›®å½•
          cp scripts/install-tailscale.sh staging/install.sh
          chmod +x staging/install.sh

      - name: Build .run Package
        run: |
          VERSION=${{ steps.meta.outputs.version }}
          OUT_NAME=${{ matrix.output_name }}
          makeself --notemp staging tailscale-${VERSION}-${OUT_NAME}.run "Tailscale ${VERSION} (${OUT_NAME})" ./install.sh

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ steps.meta.outputs.version }}"
          name: "Tailscale v${{ steps.meta.outputs.version }} Web Edition"
          files: tailscale-*.run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
