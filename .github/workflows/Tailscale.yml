name: Build Tailscale .run (Force GUI)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Tailscale Version (留空自动最新)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y makeself jq curl

      - name: Determine Version
        id: meta
        run: |
          if [ -z "${{ inputs.version }}" ]; then
            TAG=$(curl -sL https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r ".tag_name")
            VERSION=${TAG#v}
          else
            VERSION=${{ inputs.version }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download Official Binaries
        run: |
          VERSION=${{ steps.meta.outputs.version }}
          # 下载官方静态包
          curl -fSL "https://pkgs.tailscale.com/stable/tailscale_${VERSION}_amd64.tgz" -o tailscale.tgz
          tar xzf tailscale.tgz
          
          mkdir -p staging/bin
          EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "tailscale_*_amd64" | head -n 1)
          mv "$EXTRACTED_DIR/tailscale" staging/bin/
          mv "$EXTRACTED_DIR/tailscaled" staging/bin/
          rm -f tailscale.tgz
          rm -rf "$EXTRACTED_DIR"

      - name: Download LuCI & Language Packs
        run: |
          mkdir -p staging/pkgs
          
          echo "Downloading LuCI App (OpenWrt 21.02 Compatible)..."
          # 使用 OpenWrt 21.02 源，这是 iStoreOS 的底层版本，兼容性最好
          # 如果下载失败，请手动将 ipk 上传到仓库 shell 目录
          BASE_URL="https://downloads.openwrt.org/releases/21.02.7/packages/x86_64/packages"
          
          # 1. 下载主程序 LuCI
          curl -L -o staging/pkgs/luci-app.ipk "$BASE_URL/luci-app-tailscale_git-21.231.26241-f952028_all.ipk" || echo "App DL Failed"
          
          # 2. 下载中文包 (iStoreOS 必备)
          curl -L -o staging/pkgs/luci-i18n.ipk "$BASE_URL/luci-i18n-tailscale-zh-cn_git-21.231.26241-f952028_all.ipk" || echo "Lang DL Failed"

      - name: Generate Install Script (Force Extract)
        run: |
          cat << 'EOF' > staging/install.sh
          #!/bin/sh
          
          echo ">>> 1. Installing Core Binaries..."
          cp -f bin/tailscale /usr/sbin/tailscale
          cp -f bin/tailscaled /usr/sbin/tailscaled
          chmod +x /usr/sbin/tailscale /usr/sbin/tailscaled
          
          echo ">>> 2. Installing GUI (Force Extract Mode)..."
          
          # 函数：暴力解压 IPK，不依赖 opkg
          install_ipk_manual() {
              IPK_FILE="$1"
              if [ -f "$IPK_FILE" ]; then
                  echo "Extracting $IPK_FILE ..."
                  # 创建临时目录
                  mkdir -p /tmp/ts_install_temp
                  tar xzf "$IPK_FILE" -C /tmp/ts_install_temp
                  # 解压 data.tar.gz 到根目录
                  tar xzf /tmp/ts_install_temp/data.tar.gz -C /
                  # 清理
                  rm -rf /tmp/ts_install_temp
              else
                  echo "Warning: $IPK_FILE not found!"
              fi
          }
          
          # 执行解压
          install_ipk_manual "pkgs/luci-app.ipk"
          install_ipk_manual "pkgs/luci-i18n.ipk"
          
          echo ">>> 3. Configuring System..."
          
          # 确保配置文件存在
          if [ ! -f /etc/config/tailscale ]; then
              touch /etc/config/tailscale
          fi
          
          # 确保启动脚本有权限
          chmod +x /etc/init.d/tailscale
          
          # 注册 RPC 服务 (重要：否则菜单不显示)
          if [ -f /usr/share/rpcd/acl.d/luci-app-tailscale.json ]; then
             /etc/init.d/rpcd reload
          fi
          
          # 清除 LuCI 缓存 (最重要的一步)
          rm -rf /tmp/luci-indexcache
          rm -rf /tmp/luci-modulecache/
          
          # 重启服务
          /etc/init.d/tailscale enable
          /etc/init.d/tailscale restart
          
          echo "======================================================="
          echo "✅ 安装完成！"
          echo "请按 Ctrl+F5 强制刷新浏览器。"
          echo "入口位置：iStoreOS -> 服务 (Services) -> Tailscale"
          echo "或者：iStoreOS -> VPN -> Tailscale"
          echo "======================================================="
          EOF
          
          chmod +x staging/install.sh

      - name: Build .run Package
        run: |
          VERSION=${{ steps.meta.outputs.version }}
          makeself --notemp staging tailscale-${VERSION}.run "Tailscale ${VERSION} (GUI Fixed)" ./install.sh

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ steps.meta.outputs.version }}-gui-fix"
          name: "Tailscale v${{ steps.meta.outputs.version }} (Force GUI)"
          files: tailscale-${{ steps.meta.outputs.version }}.run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
