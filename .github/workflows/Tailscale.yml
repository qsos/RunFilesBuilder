name: Build Tailscale Advanced Console

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'æŒ‡å®šç‰ˆæœ¬ (ç•™ç©ºåˆ™è‡ªåŠ¨è·å–æœ€æ–°)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Tools
        run: sudo apt-get update && sudo apt-get install -y makeself jq curl

      - name: Get Version
        id: v
        run: |
          if [ -z "${{ github.event.inputs.version }}" ]; then
            VERSION=$(curl -sL https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r ".tag_name" | sed 's/v//')
          else
            VERSION=${{ github.event.inputs.version }}
          fi
          echo "tag=$VERSION" >> $GITHUB_OUTPUT

      - name: Download Binary
        run: |
          VER=${{ steps.v.outputs.tag }}
          curl -fSL "https://pkgs.tailscale.com/stable/tailscale_${VER}_amd64.tgz" -o ts.tgz
          tar xzf ts.tgz
          mkdir -p staging/bin staging/usr/lib/lua/luci/controller/ staging/usr/lib/lua/luci/view/tailscale_web/ staging/www/cgi-bin/
          mv tailscale_*/tailscale staging/bin/
          mv tailscale_*/tailscaled staging/bin/
          rm -rf ts.tgz tailscale_*

      - name: Create Backend API
        run: |
          cat > staging/www/cgi-bin/tailscale_api << 'EOF'
          #!/bin/sh
          echo "Content-type: application/json"
          echo ""
          
          TS="/bin/tailscale"
          DEBUG_LOG="/tmp/tailscale_api.log"
          
          # è®°å½•è¯·æ±‚
          echo "=== $(date) API è¯·æ±‚: $QUERY_STRING" >> $DEBUG_LOG
          
          # ç¡®ä¿ tailscaled æœåŠ¡åœ¨è¿è¡Œ
          if ! pgrep tailscaled > /dev/null 2>&1; then
              echo "tailscaled æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..." >> $DEBUG_LOG
              /etc/init.d/tailscaled start >/dev/null 2>&1
              sleep 3
          fi
          
          case "$QUERY_STRING" in
              *action=status*)
                  echo "æ‰§è¡ŒçŠ¶æ€æ£€æŸ¥..." >> $DEBUG_LOG
                  # å…ˆæ£€æŸ¥æœåŠ¡æ˜¯å¦çœŸçš„åœ¨è¿è¡Œ
                  if ! pgrep tailscaled > /dev/null 2>&1; then
                      echo "{\"active\": \"æœåŠ¡æœªè¿è¡Œ\", \"ip\": \"-\", \"devices\": []}"
                      exit 0
                  fi
                  
                  # ä½¿ç”¨æ›´ç®€å•çš„çŠ¶æ€æ£€æŸ¥æ–¹æ³•
                  ST=$($TS status 2>&1)
                  if echo "$ST" | grep -q "Failed to connect" || echo "$ST" | grep -q "not running"; then
                      echo "{\"active\": \"æœªè¿è¡Œ\", \"ip\": \"-\", \"devices\": []}"
                  else
                      # æå–IPåœ°å€
                      IP=$(echo "$ST" | grep -oE '100\.[0-9]+\.[0-9]+\.[0-9]+' | head -1 || echo "-")
                      if [ -n "$IP" ] && [ "$IP" != "-" ]; then
                          echo "{\"active\": \"è¿è¡Œä¸­\", \"ip\": \"$IP\", \"devices\": []}"
                      else
                          echo "{\"active\": \"å·²å¯åŠ¨\", \"ip\": \"-\", \"devices\": []}"
                      fi
                  fi
                  echo "çŠ¶æ€æ£€æŸ¥å®Œæˆ" >> $DEBUG_LOG ;;
                  
              *action=login*)
                  echo "å¼€å§‹ç™»å½•æµç¨‹..." >> $DEBUG_LOG
                  
                  # å…ˆåœæ­¢å¯èƒ½å­˜åœ¨çš„ tailscale è¿›ç¨‹
                  $TS down >/dev/null 2>&1
                  sleep 1
                  
                  # å…³é”®ä¿®å¤ï¼šä½¿ç”¨ tailscale up å‘½ä»¤ï¼Œå®ƒä¼šè¾“å‡ºç™»å½•é“¾æ¥
                  echo "æ‰§è¡Œ: tailscale up --accept-dns=false --reset 2>&1" >> $DEBUG_LOG
                  LOGIN_OUTPUT=$($TS up --accept-dns=false --reset 2>&1)
                  LOGIN_CODE=$?
                  echo "è¿”å›ç : $LOGIN_CODE" >> $DEBUG_LOG
                  echo "è¾“å‡º: $LOGIN_OUTPUT" >> $DEBUG_LOG
                  
                  # ä»è¾“å‡ºä¸­æå–å®Œæ•´çš„ç™»å½•URL
                  AUTH_URL=""
                  
                  # å°è¯•ä»è¾“å‡ºä¸­æå– https://login.tailscale.com/a/ å¼€å¤´çš„å®Œæ•´é“¾æ¥
                  if echo "$LOGIN_OUTPUT" | grep -q "https://login.tailscale.com/a/"; then
                      # æå–å®Œæ•´çš„URL
                      AUTH_URL=$(echo "$LOGIN_OUTPUT" | grep -o "https://login.tailscale.com/a/[^ ]*" | head -1)
                      # æ¸…ç†URLï¼Œç§»é™¤å¯èƒ½çš„å¼•å·æˆ–æ ‡ç‚¹
                      AUTH_URL=$(echo "$AUTH_URL" | sed 's/[",]*$//' | sed "s/'*$//")
                      echo "æ‰¾åˆ°ç™»å½•é“¾æ¥: $AUTH_URL" >> $DEBUG_LOG
                  fi
                  
                  # å¦‚æœæ‰¾ä¸åˆ°URLï¼Œå°è¯•ä½¿ç”¨ --qr å‚æ•°
                  if [ -z "$AUTH_URL" ]; then
                      echo "å°è¯•ä½¿ç”¨ --qr å‚æ•°..." >> $DEBUG_LOG
                      QR_OUTPUT=$($TS up --accept-dns=false --reset --qr 2>&1)
                      echo "QRè¾“å‡º: $QR_OUTPUT" >> $DEBUG_LOG
                      
                      if echo "$QR_OUTPUT" | grep -q "https://login.tailscale.com/a/"; then
                          AUTH_URL=$(echo "$QR_OUTPUT" | grep -o "https://login.tailscale.com/a/[^ ]*" | head -1)
                          AUTH_URL=$(echo "$AUTH_URL" | sed 's/[",]*$//' | sed "s/'*$//")
                          echo "æ‰¾åˆ°ç™»å½•é“¾æ¥(QR): $AUTH_URL" >> $DEBUG_LOG
                      fi
                  fi
                  
                  if [ -n "$AUTH_URL" ]; then
                      echo "{\"result\": \"ok\", \"auth_url\": \"$AUTH_URL\"}"
                  else
                      # å¦‚æœè¿˜æ˜¯æ‰¾ä¸åˆ°ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
                      echo "{\"result\": \"error\", \"message\": \"æ— æ³•è·å–ç™»å½•é“¾æ¥ï¼Œè¯·åœ¨ç»ˆç«¯æ‰§è¡Œ: tailscale up\"}"
                  fi ;;
                  
              *action=auth_check*)
                  # ç®€å•æ£€æŸ¥æ˜¯å¦å·²è®¤è¯
                  ST=$($TS status 2>&1)
                  if echo "$ST" | grep -q "100\.[0-9]+\.[0-9]+\.[0-9]+"; then
                      echo "{\"authenticated\": true}"
                  else
                      echo "{\"authenticated\": false}"
                  fi ;;
                  
              *action=logout*)
                  $TS logout >/dev/null 2>&1
                  sleep 1
                  $TS down >/dev/null 2>&1
                  echo "{\"result\": \"ok\"}" ;;
                  
              *)
                  echo "{\"error\": \"æœªçŸ¥æ“ä½œ: $QUERY_STRING\"}" ;;
          esac
          
          echo "=== è¯·æ±‚å®Œæˆ ===" >> $DEBUG_LOG
          EOF
          chmod 755 staging/www/cgi-bin/tailscale_api

      - name: Create UI
        run: |
          cat > staging/usr/lib/lua/luci/view/tailscale_web/index.htm << 'EOF'
          <%+header%>
          <style>
          .login-modal {
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0,0,0,0.5);
              z-index: 1000;
              justify-content: center;
              align-items: center;
          }
          .login-box {
              background: #fff;
              padding: 25px;
              border-radius: 10px;
              max-width: 600px;
              width: 90%;
              max-height: 80vh;
              overflow-y: auto;
          }
          .spinner {
              width: 24px;
              height: 24px;
              border: 3px solid #f3f3f3;
              border-top: 3px solid #3498db;
              border-radius: 50%;
              animation: spin 1s linear infinite;
              display: inline-block;
              vertical-align: middle;
              margin-right: 10px;
          }
          @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
          }
          .status-badge {
              padding: 4px 12px;
              border-radius: 12px;
              font-size: 14px;
              font-weight: bold;
              display: inline-block;
          }
          .status-running { background: #d4edda; color: #155724; }
          .status-stopped { background: #f8d7da; color: #721c24; }
          .status-starting { background: #fff3cd; color: #856404; }
          .login-btn {
              display: inline-block;
              padding: 12px 24px;
              background: #0066cc;
              color: white;
              text-decoration: none;
              border-radius: 6px;
              font-weight: bold;
              text-align: center;
              margin: 10px 0;
          }
          </style>
          
          <div class="cbi-map">
              <h2 style="margin-bottom:20px">Tailscale æ§åˆ¶é¢æ¿</h2>
              
              <div style="background:#fff; padding:20px; border:1px solid #ddd; border-radius:8px; margin-bottom:25px; display:flex; justify-content:space-between; align-items:center;">
                  <div>
                      <strong style="font-size:16px;">çŠ¶æ€:</strong> 
                      <span id="st-txt" class="status-badge status-starting">æ£€æµ‹ä¸­...</span>
                      <div style="margin-top:8px; color:#666;">
                          <small>å†…ç½‘åœ°å€: <code id="ip-txt">-</code></small>
                      </div>
                  </div>
                  <div style="display:flex; gap:10px;">
                      <button class="cbi-button cbi-button-apply" id="login-btn" onclick="startLogin()" style="padding:10px 20px;">
                          <span style="font-weight:bold;">âš¡ ä¸€é”®ç™»å½•</span>
                      </button>
                      <button class="cbi-button cbi-button-reset" onclick="doAction('logout')" style="padding:10px 20px;">
                          æ³¨é”€
                      </button>
                  </div>
              </div>
              
              <div id="login-modal" class="login-modal">
                  <div class="login-box">
                      <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">Tailscale ç™»å½•</h3>
                      <div style="margin:20px 0;">
                          <div id="loading-section" style="padding:15px; background:#f8f9fa; border-radius:5px; margin-bottom:20px;">
                              <span class="spinner"></span>
                              <span>æ­£åœ¨ç”Ÿæˆç™»å½•é“¾æ¥ï¼Œè¯·ç¨å€™...</span>
                          </div>
                          
                          <div id="success-section" style="display:none;">
                              <div style="background:#d4edda; padding:15px; border-radius:5px; margin-bottom:20px;">
                                  <h4 style="margin-top:0; color:#155724;">âœ“ ç™»å½•é“¾æ¥å·²ç”Ÿæˆï¼</h4>
                                  <p>è¯·åœ¨æ–°æ ‡ç­¾é¡µä¸­å®Œæˆç™»å½•ï¼Œç™»å½•æˆåŠŸåè¿”å›æ­¤é¡µé¢ã€‚</p>
                              </div>
                              
                              <div style="text-align:center; margin:20px 0;">
                                  <a id="auth-link" href="#" target="_blank" class="login-btn">
                                      ğŸ”— ç‚¹å‡»æ‰“å¼€ Tailscale ç™»å½•é¡µé¢
                                  </a>
                              </div>
                              
                              <div style="background:#fff3cd; padding:15px; border-radius:5px; border-left:4px solid #ffc107;">
                                  <h5 style="margin-top:0; color:#856404;">é‡è¦æç¤ºï¼š</h5>
                                  <ol style="margin-bottom:0; padding-left:20px; color:#856404;">
                                      <li>ç‚¹å‡»ä¸Šæ–¹é“¾æ¥åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€ç™»å½•é¡µé¢</li>
                                      <li>åœ¨ç™»å½•é¡µé¢å®Œæˆé‚®ç®±/å¯†ç éªŒè¯å’Œæ‰‹æœºéªŒè¯ç éªŒè¯</li>
                                      <li><strong>ç™»å½•æˆåŠŸåï¼Œå¯èƒ½ä¼šæ˜¾ç¤º 404 é¡µé¢ï¼Œè¿™æ˜¯æ­£å¸¸çš„</strong></li>
                                      <li>å…³é—­ 404 æ ‡ç­¾é¡µï¼Œè¿”å›æ­¤é¡µé¢ç­‰å¾…è‡ªåŠ¨åˆ·æ–°</li>
                                  </ol>
                              </div>
                              
                              <div id="status-check" style="display:none; margin-top:20px; padding:15px; background:#e8f5e8; border-radius:5px;">
                                  <div style="display:flex; align-items:center; gap:10px;">
                                      <span class="spinner" style="border-top-color:#28a745;"></span>
                                      <span id="status-message">æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€...</span>
                                  </div>
                              </div>
                          </div>
                          
                          <div id="error-section" style="display:none; background:#f8d7da; padding:15px; border-radius:5px; margin-bottom:20px;">
                              <h4 style="margin-top:0; color:#721c24;">âœ— ç™»å½•å¤±è´¥</h4>
                              <p id="error-message"></p>
                          </div>
                      </div>
                      
                      <div style="text-align:right; border-top:1px solid #eee; padding-top:20px;">
                          <button class="cbi-button" onclick="closeLoginModal()" style="padding:8px 20px;">å…³é—­</button>
                          <button id="retry-btn" class="cbi-button cbi-button-apply" onclick="generateLoginLink()" style="display:none; padding:8px 20px; margin-left:10px;">é‡è¯•</button>
                      </div>
                  </div>
              </div>
              
              <div style="margin-top:20px; padding:15px; background:#f8f9fa; border-radius:5px; border-left:4px solid #3498db;">
                  <h4 style="margin-top:0;">ä½¿ç”¨è¯´æ˜</h4>
                  <ol style="margin-bottom:0; padding-left:20px;">
                      <li>ç‚¹å‡» <strong>ä¸€é”®ç™»å½•</strong> æŒ‰é’®è·å–ç™»å½•é“¾æ¥</li>
                      <li>åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€é“¾æ¥ï¼Œå®Œæˆ Tailscale è´¦æˆ·éªŒè¯</li>
                      <li><strong>ç™»å½•æˆåŠŸåå¦‚æœæ˜¾ç¤º 404ï¼Œè¯·å…³é—­è¯¥æ ‡ç­¾é¡µ</strong></li>
                      <li>è¿”å›æ­¤é¡µé¢ï¼ŒçŠ¶æ€ä¼šè‡ªåŠ¨æ›´æ–°ä¸º"è¿è¡Œä¸­"</li>
                  </ol>
              </div>
          </div>
          
          <script>
          let loginCheckInterval = null;
          
          async function refresh() {
              try {
                  const response = await fetch('/cgi-bin/tailscale_api?action=status&t=' + Date.now());
                  const data = await response.json();
                  
                  const statusEl = document.getElementById('st-txt');
                  const ipEl = document.getElementById('ip-txt');
                  
                  if (data.active === "è¿è¡Œä¸­") {
                      statusEl.textContent = "è¿è¡Œä¸­";
                      statusEl.className = "status-badge status-running";
                      ipEl.textContent = data.ip || '-';
                  } else if (data.active === "å·²å¯åŠ¨") {
                      statusEl.textContent = "å·²å¯åŠ¨";
                      statusEl.className = "status-badge status-starting";
                      ipEl.textContent = data.ip || '-';
                  } else {
                      statusEl.textContent = data.active || "æœªè¿è¡Œ";
                      statusEl.className = "status-badge status-stopped";
                      ipEl.textContent = '-';
                  }
              } catch (error) {
                  console.error('åˆ·æ–°å¤±è´¥:', error);
                  document.getElementById('st-txt').textContent = "è¿æ¥é”™è¯¯";
                  document.getElementById('st-txt').className = "status-badge status-stopped";
              }
          }
          
          function startLogin() {
              document.getElementById('login-modal').style.display = 'flex';
              generateLoginLink();
          }
          
          async function generateLoginLink() {
              // é‡ç½®UI
              document.getElementById('loading-section').style.display = 'block';
              document.getElementById('success-section').style.display = 'none';
              document.getElementById('status-check').style.display = 'none';
              document.getElementById('error-section').style.display = 'none';
              document.getElementById('retry-btn').style.display = 'none';
              
              try {
                  const response = await fetch('/cgi-bin/tailscale_api?action=login&t=' + Date.now());
                  const data = await response.json();
                  
                  if (data.result === 'ok' && data.auth_url) {
                      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                      document.getElementById('loading-section').style.display = 'none';
                      document.getElementById('success-section').style.display = 'block';
                      document.getElementById('status-check').style.display = 'block';
                      
                      // è®¾ç½®é“¾æ¥
                      const authLink = document.getElementById('auth-link');
                      authLink.href = data.auth_url;
                      
                      // å¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€
                      startAuthCheck();
                  } else {
                      // æ˜¾ç¤ºé”™è¯¯
                      document.getElementById('loading-section').style.display = 'none';
                      document.getElementById('error-section').style.display = 'block';
                      document.getElementById('error-message').textContent = data.message || 'ç™»å½•é“¾æ¥ç”Ÿæˆå¤±è´¥';
                      document.getElementById('retry-btn').style.display = 'inline-block';
                  }
              } catch (error) {
                  console.error('è¯·æ±‚å¤±è´¥:', error);
                  document.getElementById('loading-section').style.display = 'none';
                  document.getElementById('error-section').style.display = 'block';
                  document.getElementById('error-message').textContent = 'è¯·æ±‚å¤±è´¥: ' + error.message;
                  document.getElementById('retry-btn').style.display = 'inline-block';
              }
          }
          
          function startAuthCheck() {
              if (loginCheckInterval) clearInterval(loginCheckInterval);
              
              let checkCount = 0;
              const maxChecks = 90; // æœ€å¤šæ£€æŸ¥90æ¬¡ï¼ˆ3åˆ†é’Ÿï¼‰
              
              loginCheckInterval = setInterval(async () => {
                  checkCount++;
                  
                  try {
                      const response = await fetch('/cgi-bin/tailscale_api?action=auth_check&t=' + Date.now());
                      const data = await response.json();
                      
                      if (data.authenticated) {
                          document.getElementById('status-message').innerHTML = '<strong style="color:#155724;">âœ“ ç™»å½•æˆåŠŸï¼æ­£åœ¨åˆ·æ–°çŠ¶æ€...</strong>';
                          
                          clearInterval(loginCheckInterval);
                          loginCheckInterval = null;
                          
                          // ç­‰å¾…3ç§’åå…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°
                          setTimeout(() => {
                              closeLoginModal();
                              refresh();
                              // å†ç­‰2ç§’åˆ·æ–°ä¸€æ¬¡ç¡®ä¿çŠ¶æ€æ­£ç¡®
                              setTimeout(refresh, 2000);
                          }, 3000);
                          
                          return;
                      }
                      
                      // æ›´æ–°çŠ¶æ€æ¶ˆæ¯
                      const minutes = Math.floor(checkCount * 2 / 60);
                      const seconds = (checkCount * 2) % 60;
                      document.getElementById('status-message').innerHTML = 
                          `æ­£åœ¨æ£€æŸ¥ç™»å½•çŠ¶æ€... (å·²ç­‰å¾… ${minutes}åˆ†${seconds}ç§’)<br>
                          è¯·åœ¨æ–°æ ‡ç­¾é¡µä¸­å®Œæˆç™»å½•éªŒè¯`;
                      
                      // è¶…è¿‡æœ€å¤§æ£€æŸ¥æ¬¡æ•°åˆ™åœæ­¢
                      if (checkCount >= maxChecks) {
                          clearInterval(loginCheckInterval);
                          loginCheckInterval = null;
                          document.getElementById('status-message').innerHTML = 
                              '<span style="color:#721c24;">ç™»å½•è¶…æ—¶ï¼Œè¯·é‡æ–°å°è¯•</span>';
                          document.getElementById('retry-btn').style.display = 'inline-block';
                      }
                  } catch (error) {
                      console.error('çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                  }
              }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
          }
          
          function closeLoginModal() {
              document.getElementById('login-modal').style.display = 'none';
              if (loginCheckInterval) {
                  clearInterval(loginCheckInterval);
                  loginCheckInterval = null;
              }
          }
          
          async function doAction(action) {
              if (action === 'logout' && !confirm('ç¡®å®šè¦æ³¨é”€ Tailscale å—ï¼Ÿ')) {
                  return;
              }
              
              try {
                  await fetch(`/cgi-bin/tailscale_api?action=${action}&t=${Date.now()}`);
                  refresh();
                  if (action === 'logout') {
                      alert('æ³¨é”€æˆåŠŸ');
                  }
              } catch (error) {
                  console.error('æ“ä½œå¤±è´¥:', error);
                  alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
              }
          }
          
          // åˆå§‹åˆ·æ–°
          refresh();
          // æ¯10ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
          setInterval(refresh, 10000);
          </script>
          <%+footer%>
          EOF

      - name: Create Controller
        run: |
          cat > staging/usr/lib/lua/luci/controller/tailscale_web.lua << 'EOF'
          module("luci.controller.tailscale_web", package.seeall)
          function index()
              entry({"admin", "services", "tailscale_web"}, template("tailscale_web/index"), _("Tailscale"), 99)
          end
          EOF

      - name: Build Package
        run: |
          cp shell/install-tailscale.sh staging/install.sh
          chmod +x staging/install.sh
          makeself --notemp staging "tailscale-${{ steps.v.outputs.tag }}-x86.run" "Tailscale" ./install.sh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ steps.v.outputs.tag }}"
          name: "Tailscale-Console-v${{ steps.v.outputs.tag }}"
          files: "*.run"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
