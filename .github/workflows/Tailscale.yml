name: Build Tailscale Console

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    strategy:
      matrix:
        include:
          - arch: amd64
            output_name: x86
          - arch: arm64
            output_name: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Tools
        run: sudo apt-get update && sudo apt-get install -y makeself jq curl

      - name: Download and Prepare Staging
        id: meta
        run: |
          VERSION=$(curl -sL https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r ".tag_name" | sed 's/v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          curl -fSL "https://pkgs.tailscale.com/stable/tailscale_${VERSION}_${{ matrix.arch }}.tgz" -o tailscale.tgz
          tar xzf tailscale.tgz
          mkdir -p staging/bin staging/usr/lib/lua/luci/controller/ staging/usr/lib/lua/luci/view/tailscale_web/ staging/www/cgi-bin/
          mv tailscale_*/tailscale staging/bin/
          mv tailscale_*/tailscaled staging/bin/

      - name: Create Backend API
        run: |
          cat << 'EOF' > staging/www/cgi-bin/tailscale_api
          #!/bin/sh
          echo "Content-type: application/json"
          echo ""
          case "$QUERY_STRING" in
              *action=status*)
                  ST=$(/usr/sbin/tailscale status --json 2>/dev/null)
                  if [ $? -ne 0 ]; then
                      echo "{\"active\": \"未启动\", \"ip\": \"-\"}"
                  else
                      BACKEND=$(echo "$ST" | jq -r '.BackendState')
                      IP=$(echo "$ST" | jq -r '.TailscaleIPs[0] // "-"')
                      AUTH=$(echo "$ST" | jq -r '.AuthURL // ""')
                      echo "{\"active\": \"$BACKEND\", \"ip\": \"$IP\", \"url\": \"$AUTH\"}"
                  fi
                  ;;
              *action=login*)
                  /usr/sbin/tailscale up --accept-dns=false >/dev/null 2>&1 &
                  echo "{\"result\": \"success\"}"
                  ;;
              *action=logout*)
                  /usr/sbin/tailscale logout >/dev/null 2>&1
                  echo "{\"result\": \"success\"}"
                  ;;
          esac
          EOF
          chmod +x staging/www/cgi-bin/tailscale_api

      - name: Create Console UI
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/view/tailscale_web/index.htm
          <%+header%>
          <div class="cbi-map">
              <h2 name="content">Tailscale 交互控制台</h2>
              <fieldset class="cbi-section">
                  <div style="padding:20px; background:#f9f9f9; border-radius:8px; border:1px solid #ddd;">
                      <p>节点状态: <b id="ts-status" style="color:orange;">获取中...</b></p>
                      <p>内网地址: <b id="ts-ip">-</b></p>
                      <hr/>
                      <div style="margin-top:15px;">
                          <button class="cbi-button cbi-button-apply important" onclick="doAct('login')">一键上线</button>
                          <button class="cbi-button cbi-button-reset" onclick="doAct('logout')">注销退出</button>
                      </div>
                      <div id="login-box" style="display:none; margin-top:15px; background:#fffbe6; padding:10px; border:1px solid #ffe58f;">
                          <p>需要授权，请点击链接登录：</p>
                          <a id="ts-url" href="#" target="_blank" style="color:#
