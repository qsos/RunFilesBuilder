name: Build Tailscale iStoreOS Simple Console

on:
  workflow_dispatch:
    inputs:
      version:
        description: '指定版本 (留空则自动获取最新)'
        required: false
        default: ''

permissions:
  contents: write
  actions: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Tools
        run: sudo apt-get update && sudo apt-get install -y makeself jq curl

      - name: Get Version
        id: v
        run: |
          if [ -z "${{ github.event.inputs.version }}" ]; then
            VERSION=$(curl -sL https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r ".tag_name" | sed 's/v//')
          else
            VERSION=${{ github.event.inputs.version }}
          fi
          echo "tag=$VERSION" >> $GITHUB_OUTPUT

      - name: Download Binary
        run: |
          VER=${{ steps.v.outputs.tag }}
          curl -fSL "https://pkgs.tailscale.com/stable/tailscale_${VER}_amd64.tgz" -o ts.tgz
          tar xzf ts.tgz
          mkdir -p staging/bin staging/usr/lib/lua/luci/controller/ staging/usr/lib/lua/luci/view/tailscale_web/ staging/www/cgi-bin/
          mv tailscale_*/tailscale staging/bin/
          mv tailscale_*/tailscaled staging/bin/
          rm -rf ts.tgz tailscale_*

      - name: Create Backend API (修复登录注销)
        run: |
          cat << 'EOF' > staging/www/cgi-bin/tailscale_api
          #!/bin/sh
          echo "Content-type: application/json"
          echo ""
          
          # 1. 处理控制动作
          case "$QUERY_STRING" in
              *action=login*)
                  /usr/sbin/tailscale up --accept-dns=false --reset >/dev/null 2>&1 &
                  echo "{\"result\": \"ok\"}"
                  exit 0
                  ;;
              *action=logout*)
                  /usr/sbin/tailscale logout >/dev/null 2>&1
                  echo "{\"result\": \"ok\"}"
                  exit 0
                  ;;
          esac

          # 2. 获取状态数据
          ST=$(/usr/sbin/tailscale status --json 2>/dev/null)
          if [ $? -ne 0 ]; then
              echo "{\"active\": \"未运行\"}"
          else
              IP=$(echo "$ST" | jq -r '.Self.TailscaleIPs[0] // "-"')
              # 精准抓取版本和系统，防止出现 null
              DEVICES=$(echo "$ST" | jq -c '.Peer | to_entries | map({
                  name: .value.HostName,
                  ip: (.value.TailscaleIPs[0] // "-"),
                  os: (.value.OS // "Linux"),
                  ver: (.value.Version // "-"),
                  online: .value.Online
              })')
              echo "{\"active\": \"运行中\", \"ip\": \"$IP\", \"devices\": $DEVICES}"
          fi
          EOF
          chmod 755 staging/www/cgi-bin/tailscale_api

      - name: Create UI (简约中文布局)
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/view/tailscale_web/index.htm
          <%+header%>
          <style>
              .ts-card { background: #fff; padding: 20px; border: 1px solid #d9d9d9; border-radius: 4px; margin-bottom: 20px; }
              .ts-flex { display: flex; justify-content: space-between; align-items: center; }
              .ts-status { font-size: 16px; font-weight: bold; }
              .ts-ip { color: #888; font-size: 13px; margin-top: 5px; }
              .status-ok { color: #52c41a; } .status-err { color: #ff4d4f; }
              
              .ts-table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 1px solid #f0f0f0; }
              .ts-table th { background: #fafafa; padding: 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
              .ts-table td { padding: 12px; border-bottom: 1px solid #f0f0f0; }
              
              .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 8px; }
              .dot-on { background: #52c41a; } .dot-off { background: #bfbfbf; }
              .sys-info { font-size: 11px; color: #999; }
          </style>

          <div class="cbi-map">
              <h2 style="margin-bottom:15px">Tailscale 控制面板</h2>
              
              <div class="ts-card ts-flex">
                  <div>
                      <div class="ts-status">状态: <span id="st-txt">读取中...</span></div>
                      <div class="ts-ip">内网地址: <span id="st-ip">-</span></div>
                  </div>
                  <div>
                      <button class="cbi-button cbi-button-apply" onclick="runAction('login')">一键上线</button>
                      <button class="cbi-button cbi-button-reset" onclick="runAction('logout')">注销退出</button>
                  </div>
              </div>

              <div class="cbi-section">
                  <table class="ts-table" id="dev-list">
                      <thead>
                          <tr>
                              <th>设备名称</th>
                              <th>内网 IP</th>
                              <th>版本 / 系统</th>
                              <th>状态</th>
                          </tr>
                      </thead>
                      <tbody></tbody>
                  </table>
              </div>
          </div>

          <script>
              function updateUI() {
                  fetch('/cgi-bin/tailscale_api').then(r => r.json()).then(d => {
                      const txt = document.getElementById('st-txt');
                      txt.innerText = d.active || "未连接";
                      txt.className = d.active === "运行中" ? "status-ok" : "status-err";
                      document.getElementById('st-ip').innerText = d.ip || "-";

                      const body = document.querySelector('#dev-list tbody');
                      body.innerHTML = '';
                      if(d.devices && d.devices.length > 0) {
                          d.devices.forEach(dev => {
                              body.innerHTML += `<tr>
                                  <td><strong>${dev.name}</strong></td>
                                  <td><code>${dev.ip}</code></td>
                                  <td>${dev.ver}<br><span class="sys-info">${dev.os}</span></td>
                                  <td><span class="dot ${dev.online?'dot-on':'dot-off'}"></span>${dev.online?'在线':'离线'}</td>
                              </tr>`;
                          });
                      } else {
                          body.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:20px;color:#999">暂无网络节点</td></tr>';
                      }
                  });
              }

              function runAction(a) {
                  fetch('/cgi-bin/tailscale_api?action=' + a).then(() => {
                      setTimeout(updateUI, 2000);
                  });
              }

              updateUI();
              setInterval(updateUI, 8000);
          </script>
          <%+footer%>
          EOF

      - name: Create Controller
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/controller/tailscale_web.lua
          module("luci.controller.tailscale_web", package.seeall)
          function index()
              entry({"admin", "services", "tailscale_web"}, template("tailscale_web/index"), _("Tailscale 控制台"), 99)
          end
          EOF

      - name: Build Package
        run: |
          cp shell/install-tailscale.sh staging/install.sh
          chmod +x staging/install.sh
          makeself --notemp staging "tailscale-${{ steps.v.outputs.tag }}-x86.run" "Tailscale" ./install.sh

      - name: Create Release (参照 PassWall 命名格式)
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ steps.v.outputs.tag }}"
          name: "Tailscale-Console-v${{ steps.v.outputs.tag }}" # 修正命名：插件名-版本号
          files: "*.run"
          body: |
            ## Tailscale iStoreOS 控制面板
            - 内核版本: ${{ steps.v.outputs.tag }}
            - 适配 iStoreOS 原生浅色界面
            - 优化登录/注销逻辑
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
