name: Build Tailscale Official UI Mode

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Workspace
        run: |
          mkdir -p staging/bin \
                   staging/www/cgi-bin/ \
                   staging/www/luci-static/resources/view/ \
                   staging/usr/lib/lua/luci/controller/
          sudo apt-get update && sudo apt-get install -y makeself jq curl

      - name: Download Tailscale Binary
        run: |
          VERSION=$(curl -sL https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r ".tag_name" | sed 's/v//')
          curl -fSL "https://pkgs.tailscale.com/stable/tailscale_${VERSION}_amd64.tgz" -o ts.tgz
          tar xzf ts.tgz
          mv tailscale_*/tailscale staging/bin/
          mv tailscale_*/tailscaled staging/bin/

      - name: Process Official JS (Fix Login Button)
        run: |
          # 1. 复制你提供给我的那段官方 tailscale.js 到 staging 目录
          # 注意：确保你的仓库根目录下有名为 tailscale.js 的文件
          cp tailscale.js staging/www/luci-static/resources/view/tailscale.js
          
          # 2. 使用 sed 暴力修改 JS，将 RPC 替换为直接 Fetch，彻底解决 404
          # 强制将 callGetStatus 映射到我们的 API
          sed -i "s|rpc.declare({object:'tailscale',method:'get_status'})|function(){return fetch('/cgi-bin/tailscale_api?action=status').then(r=>r.json())}|g" staging/www/luci-static/resources/view/tailscale.js
          
          # 强制将 callDoLogout 映射到我们的 API
          sed -i "s|rpc.declare({object:'tailscale',method:'do_logout'})|function(){return fetch('/cgi-bin/tailscale_api?action=logout').then(r=>r.json())}|g" staging/www/luci-static/resources/view/tailscale.js

      - name: Create Backend API (适配官方格式)
        run: |
          cat << 'EOF' > staging/www/cgi-bin/tailscale_api
          #!/bin/sh
          echo "Content-type: application/json"
          echo ""
          TS="/bin/tailscale"
          case "$QUERY_STRING" in
              action=status)
                  ST=$($TS status --json 2>/dev/null)
                  # 提取状态。如果是空或者未运行，给官方 JS 返回 'logout' 字符串
                  BACKEND_ST=$(echo "$ST" | jq -r '.BackendState // "logout"')
                  if [ "$BACKEND_ST" != "Running" ]; then
                      # 抓取最新的新鲜授权链接
                      URL=$($TS up --accept-dns=false --reset 2>&1 | grep -o 'https://login.tailscale.com/a/[^ ]*' | head -n 1)
                      # 构造官方 JS 预期的 JSON 结构
                      echo "{\"status\": \"logout\", \"health\": \"\", \"url\": \"$URL\", \"peers\": {}}"
                  else
                      IPV4=$(echo "$ST" | jq -r '.Self.TailscaleIPs[0] // "-"')
                      VERSION=$(echo "$ST" | jq -r '.Version // "-"')
                      # 返回官方 JS 渲染表格所需的数据
                      echo "{\"status\": \"running\", \"version\": \"$VERSION\", \"ipv4\": \"$IPV4\", \"peers\": {}}"
                  fi ;;
              action=logout)
                  $TS logout >/dev/null 2>&1
                  echo "{\"success\": true}" ;;
          esac
          EOF
          chmod 755 staging/www/cgi-bin/tailscale_api

      - name: Create Simple Controller
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/controller/tailscale.lua
          module("luci.controller.tailscale", package.seeall)
          function index()
              entry({"admin", "services", "tailscale"}, template("tailscale_web/index"), _("Tailscale"), 99)
          end
          EOF

      - name: Build Setup Package
        run: |
          # 确保安装脚本已经更新为适配官方路径的版本
          cp shell/install-tailscale.sh staging/install.sh
          chmod +x staging/install.sh
          makeself staging "tailscale-setup.run" "Tailscale Official UI Patch" ./install.sh

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ github.run_number }}"
          files: "*.run"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
