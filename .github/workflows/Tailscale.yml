name: Build Tailscale .run (x86_64)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y golang make gcc tar gzip

      - name: Download Tailscale source (v1.92.3)
        run: |
          curl -L -o tailscale-src.tar.gz \
          https://codeload.github.com/tailscale/tailscale/tar.gz/refs/tags/v1.92.3

          tar xf tailscale-src.tar.gz
          mv tailscale-* tailscale-src

      - name: Build tailscale binaries
        run: |
          cd tailscale-src
          export CGO_ENABLED=0
          export GOOS=linux
          export GOARCH=amd64
          go build -o tailscaled ./cmd/tailscaled
          go build -o tailscale  ./cmd/tailscale

      - name: Prepare run package directory
        run: |
          mkdir -p runpkg
          cp tailscale-src/tailscaled runpkg/
          cp tailscale-src/tailscale  runpkg/
          cp tailscale-src/cmd/tailscaled/tailscaled.service runpkg/
          cp shell/install-tailscale.sh runpkg/install.sh
          chmod +x runpkg/install.sh

      - name: Build .run installer
        run: |
          cd runpkg
          cat > tailscale-1.92.3-x86_64.run <<'EOF'
#!/bin/sh
set -e
TMPDIR=$(mktemp -d)
ARCHIVE_LINE=$(awk '/^__ARCHIVE_BELOW__/ {print NR + 1; exit 0; }' "$0")
tail -n +"$ARCHIVE_LINE" "$0" | tar xz -C "$TMPDIR"
cd "$TMPDIR"
sh install.sh
exit 0
__ARCHIVE_BELOW__
EOF

          tar czf payload.tar.gz *
          cat payload.tar.gz >> tailscale-1.92.3-x86_64.run
          chmod +x tailscale-1.92.3-x86_64.run

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-run
          path: runpkg/tailscale-1.92.3-x86_64.run
