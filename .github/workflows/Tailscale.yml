name: Build Tailscale Run

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl tar gcc musl-tools golang makeself

      - name: Download Tailscale source
        run: |
          mkdir -p tailscale-src
          curl -L -o tailscale-src/tailscale-1.92.3.tar.gz \
               https://codeload.github.com/tailscale/tailscale/tar.gz/refs/tags/v1.92.3
          tar zxvf tailscale-src/tailscale-1.92.3.tar.gz -C tailscale-src --strip-components=1

      - name: Compile Tailscale x86_64 musl
        run: |
          cd tailscale-src
          CC=musl-gcc GOOS=linux GOARCH=amd64 go build -o tailscaled ./cmd/tailscaled
          CC=musl-gcc GOOS=linux GOARCH=amd64 go build -o tailscale ./cmd/tailscale
          mkdir -p x86_64
          mv tailscaled tailscale x86_64/

      - name: Copy LuCI ipk
        run: |
          mkdir -p x86_64
          cp shell/luci-app-tailscale_1.2.6-r19_all.ipk x86_64/

      - name: Copy install script
        run: cp shell/install-tailscale.sh x86_64/

      - name: Build .run package
        run: |
          cd x86_64
          chmod +x install-tailscale.sh
          makeself --notemp . ../tailscale-1.92.3.run "Tailscale Installer 1.92.3" ./install-tailscale.sh

      - name: Upload .run to release
        uses: softprops/action-gh-release@v2.1.0
        with:
          tag_name: "tailscale-1.92.3"
          name: "tailscale-1.92.3.run"
          files: tailscale-1.92.3.run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
