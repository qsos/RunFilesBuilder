name: build-tailscale-run

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - uses: actions/checkout@v4

      - name: Install makeself
        run: |
          sudo apt-get update
          sudo apt-get install -y makeself jq

      - name: Prepare staging
        run: |
          mkdir -p staging/bin
          mkdir -p staging/www/cgi-bin
          mkdir -p staging/usr/lib/lua/luci/view/tailscale_web

      # ====== 你的后端 API（不动逻辑）======
      - name: Create tailscale_api
        run: |
          cat << 'EOF' > staging/www/cgi-bin/tailscale_api
          #!/bin/sh
          echo "Content-type: application/json"
          echo ""
          TS="/bin/tailscale"
          case "$QUERY_STRING" in
            *action=status*)
              ST=$($TS status --json 2>/dev/null)
              ACTIVE=$(echo "$ST" | jq -r '.BackendState // "未运行"')
              if [ "$ACTIVE" != "Running" ]; then
                URL=$($TS up --accept-dns=false --reset 2>&1 | grep -o 'https://login.tailscale.com/a/[^ ]*')
                echo "{\"active\":\"未登录\",\"url\":\"$URL\",\"devices\":[]}"
              else
                IP=$(echo "$ST" | jq -r '.Self.TailscaleIPs[0] // "-"')
                DEVICES=$(echo "$ST" | jq -c '.Peer | to_entries | map({hostname:.value.HostName,ip:(.value.TailscaleIPs[0]//\"-\"),online:.value.Online})')
                echo "{\"active\":\"运行中\",\"ip\":\"$IP\",\"devices\":$DEVICES}"
              fi
            ;;
            *action=logout*)
              $TS logout >/dev/null 2>&1
              echo "{\"result\":\"ok\"}"
            ;;
          esac
          EOF
          chmod 755 staging/www/cgi-bin/tailscale_api

      # ====== LuCI 页面：只修 404（关键点）======
      - name: Create LuCI view (fix 404)
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/view/tailscale_web/index.htm
          <%+header%>
          <div class="cbi-map">
            <h2>Tailscale 控制面板</h2>
            <div id="auth">
              <a id="link" href="#" target="_blank">授权</a>
            </div>
          </div>
          <script>
            fetch('/cgi-bin/luci/tailscale_api?action=status')
              .then(r=>r.json())
              .then(d=>{
                if(d.url){
                  document.getElementById('link').href=d.url;
                }
              });
          </script>
          <%+footer%>
          EOF

      # ====== 你的安装脚本（你之前就有的）======
      - name: Create install.sh
        run: |
          cat << 'EOF' > staging/install.sh
          #!/bin/sh
          killall -9 tailscale tailscaled 2>/dev/null
          /etc/init.d/tailscaled stop 2>/dev/null
          rm -f /etc/tailscale/tailscaled.state

          mkdir -p /bin /www/cgi-bin /usr/lib/lua/luci/view/tailscale_web
          cp -f bin/tailscale* /bin/ 2>/dev/null
          cp -f www/cgi-bin/tailscale_api /www/cgi-bin/
          cp -f usr/lib/lua/luci/view/tailscale_web/index.htm /usr/lib/lua/luci/view/tailscale_web/
          chmod +x /www/cgi-bin/tailscale_api

          cat << 'EOT' > /etc/init.d/tailscaled
          #!/bin/sh /etc/rc.common
          START=99
          USE_PROCD=1
          start_service() {
            procd_open_instance
            procd_set_param command /bin/tailscaled --state /etc/tailscale/tailscaled.state
            procd_set_param respawn
            procd_close_instance
          }
          EOT

          chmod +x /etc/init.d/tailscaled
          /etc/init.d/tailscaled enable
          /etc/init.d/tailscaled start
          rm -rf /tmp/luci-*
          EOF
          chmod +x staging/install.sh

      # ====== 关键：直接生成 .run ======
      - name: Build .run
        run: |
          makeself staging tailscale.run "Tailscale for iStoreOS" ./install.sh
          ls -lh tailscale.run

      - name: Upload run file
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-run
          path: tailscale.run
