name: Build Tailscale Advanced Console

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'æŒ‡å®šç‰ˆæœ¬ (ç•™ç©ºåˆ™è‡ªåŠ¨è·å–æœ€æ–°)'
        required: false
        default: ''

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Tools
        run: sudo apt-get update && sudo apt-get install -y makeself jq curl

      - name: Get Version
        id: v
        run: |
          if [ -z "${{ github.event.inputs.version }}" ]; then
            VERSION=$(curl -sL https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r ".tag_name" | sed 's/v//')
          else
            VERSION=${{ github.event.inputs.version }}
          fi
          echo "tag=$VERSION" >> $GITHUB_OUTPUT

      - name: Download Binary
        run: |
          VER=${{ steps.v.outputs.tag }}
          curl -fSL "https://pkgs.tailscale.com/stable/tailscale_${VER}_amd64.tgz" -o ts.tgz
          tar xzf ts.tgz
          mkdir -p staging/bin staging/usr/lib/lua/luci/controller/ staging/usr/lib/lua/luci/view/tailscale_web/ staging/www/cgi-bin/
          mv tailscale_*/tailscale staging/bin/
          mv tailscale_*/tailscaled staging/bin/
          rm -rf ts.tgz tailscale_*

      - name: Create Backend API
        run: |
          cat << 'EOF' > staging/www/cgi-bin/tailscale_api
          #!/bin/sh
          echo "Content-type: application/json"
          echo ""
          
          TS="/bin/tailscale"
          TS_STATE="/etc/tailscale/tailscaled.state"
          
          # è°ƒè¯•ä¿¡æ¯
          DEBUG_LOG="/tmp/tailscale_api.log"
          echo "=== API è¯·æ±‚: $QUERY_STRING ===" >> $DEBUG_LOG
          echo "æ—¶é—´: $(date)" >> $DEBUG_LOG
          
          # ç¡®ä¿ tailscale å‘½ä»¤å¯ç”¨
          if [ ! -x "$TS" ]; then
              echo "{\"error\": \"tailscale å‘½ä»¤æœªæ‰¾åˆ°æˆ–ä¸å¯æ‰§è¡Œ\"}" >> $DEBUG_LOG
              echo "{\"error\": \"tailscale å‘½ä»¤æœªæ‰¾åˆ°æˆ–ä¸å¯æ‰§è¡Œ\"}"
              exit 0
          fi
          
          # æ£€æŸ¥æœåŠ¡æ˜¯å¦è¿è¡Œ
          if ! pgrep tailscaled > /dev/null 2>&1; then
              echo "æœåŠ¡æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..." >> $DEBUG_LOG
              /etc/init.d/tailscaled start >/dev/null 2>&1
              sleep 2
          fi
          
          case "$QUERY_STRING" in
              *action=status*)
                  echo "æ‰§è¡ŒçŠ¶æ€æ£€æŸ¥" >> $DEBUG_LOG
                  ST=$($TS status --json 2>/dev/null)
                  STATUS_CODE=$?
                  echo "è¿”å›ç : $STATUS_CODE" >> $DEBUG_LOG
                  echo "è¾“å‡ºé•¿åº¦: ${#ST}" >> $DEBUG_LOG
                  
                  if [ $STATUS_CODE -ne 0 ] || [ -z "$ST" ]; then 
                      echo "{\"active\": \"æœªè¿è¡Œ\", \"ip\": \"-\", \"devices\": [], \"debug\": \"çŠ¶æ€ç : $STATUS_CODE\"}"
                  else
                      IP=$(echo "$ST" | jq -r '.Self.TailscaleIPs[0] // "-"' 2>/dev/null || echo "-")
                      if [ "$IP" = "null" ] || [ -z "$IP" ]; then
                          IP="-"
                      fi
                      
                      # æå–è®¾å¤‡ä¿¡æ¯
                      if echo "$ST" | jq -e '.Peer' >/dev/null 2>&1; then
                          DEVICES=$(echo "$ST" | jq -c '.Peer | to_entries | map({hostname: .value.HostName, ip: (.value.TailscaleIPs[0] // "-"), os: (.value.OS // "-"), version: (.value.Version // "-"), online: .value.Online})' 2>/dev/null || echo "[]")
                      else
                          DEVICES="[]"
                      fi
                      
                      echo "IP: $IP, è®¾å¤‡æ•°: $(echo $DEVICES | jq length 2>/dev/null || echo 0)" >> $DEBUG_LOG
                      echo "{\"active\": \"è¿è¡Œä¸­\", \"ip\": \"$IP\", \"devices\": $DEVICES}"
                  fi ;;
                  
              *action=login*)
                  echo "å¼€å§‹ç™»å½•æµç¨‹" >> $DEBUG_LOG
                  
                  # ç”Ÿæˆç™»å½•é“¾æ¥ï¼ˆä½¿ç”¨ --qr å‚æ•°ï¼‰
                  echo "æ‰§è¡Œ tailscale up --qr --json" >> $DEBUG_LOG
                  LOGIN_OUTPUT=$($TS up --accept-dns=false --reset --qr --json 2>&1)
                  LOGIN_CODE=$?
                  echo "ç™»å½•å‘½ä»¤è¿”å›ç : $LOGIN_CODE" >> $DEBUG_LOG
                  echo "ç™»å½•è¾“å‡º: $LOGIN_OUTPUT" >> $DEBUG_LOG
                  
                  # å°è¯•å¤šç§æ–¹å¼æå– URL
                  AUTH_URL=""
                  if echo "$LOGIN_OUTPUT" | grep -q 'https://'; then
                      AUTH_URL=$(echo "$LOGIN_OUTPUT" | grep -o 'https://[^ ]*' | head -1)
                  elif echo "$LOGIN_OUTPUT" | jq -e '.url' >/dev/null 2>&1; then
                      AUTH_URL=$(echo "$LOGIN_OUTPUT" | jq -r '.url')
                  fi
                  
                  if [ -n "$AUTH_URL" ]; then
                      echo "è·å–åˆ°ç™»å½•é“¾æ¥: $AUTH_URL" >> $DEBUG_LOG
                      echo "{\"result\": \"ok\", \"auth_url\": \"$AUTH_URL\", \"message\": \"è¯·åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ­¤é“¾æ¥å®Œæˆç™»å½•\"}"
                  else
                      echo "æ— æ³•è·å–ç™»å½•é“¾æ¥" >> $DEBUG_LOG
                      echo "{\"result\": \"error\", \"message\": \"æ— æ³•ç”Ÿæˆç™»å½•é“¾æ¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡çŠ¶æ€\"}"
                  fi ;;
                  
              *action=auth_check*)
                  ST=$($TS status --json 2>/dev/null)
                  if [ $? -eq 0 ] && echo "$ST" | jq -e '.Self.UserID != 0' >/dev/null 2>&1; then
                      echo "{\"authenticated\": true}"
                  else
                      echo "{\"authenticated\": false}"
                  fi ;;
                  
              *action=logout*)
                  $TS logout >/dev/null 2>&1
                  echo "{\"result\": \"ok\"}" ;;
                  
              *)
                  echo "{\"error\": \"æœªçŸ¥æ“ä½œ: $QUERY_STRING\"}" ;;
          esac
          
          echo "=== è¯·æ±‚ç»“æŸ ===" >> $DEBUG_LOG
          EOF
          chmod 755 staging/www/cgi-bin/tailscale_api

      - name: Create UI
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/view/tailscale_web/index.htm
          <%+header%>
          <style>
          .login-modal {
              display: none;
              position: fixed;
              top: 0;
              left: 0;
              width: 100%;
              height: 100%;
              background: rgba(0,0,0,0.5);
              z-index: 1000;
              justify-content: center;
              align-items: center;
          }
          .login-box {
              background: #fff;
              padding: 25px;
              border-radius: 10px;
              max-width: 600px;
              width: 90%;
              max-height: 80vh;
              overflow-y: auto;
          }
          .status-badge {
              display: inline-block;
              padding: 4px 12px;
              border-radius: 12px;
              font-size: 14px;
              font-weight: bold;
          }
          .status-running { background: #d4edda; color: #155724; }
          .status-stopped { background: #f8d7da; color: #721c24; }
          .device-table {
              margin-top: 20px;
              border: 1px solid #dee2e6;
              border-radius: 5px;
              overflow: hidden;
          }
          .device-table th {
              background: #f8f9fa;
              padding: 12px;
              text-align: left;
              font-weight: 600;
          }
          .device-table td {
              padding: 12px;
              border-top: 1px solid #dee2e6;
          }
          .online-dot {
              display: inline-block;
              width: 10px;
              height: 10px;
              border-radius: 50%;
              margin-right: 6px;
          }
          .online { background: #28a745; }
          .offline { background: #6c757d; }
          </style>
          
          <div class="cbi-map">
              <h2 style="margin-bottom:20px">Tailscale æ§åˆ¶é¢æ¿</h2>
              
              <div style="background:#fff; padding:20px; border:1px solid #ddd; border-radius:8px; margin-bottom:25px; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                  <div>
                      <strong style="font-size:16px;">çŠ¶æ€:</strong> 
                      <span id="st-txt" class="status-badge status-stopped">æ£€æµ‹ä¸­...</span>
                      <div style="margin-top:8px; color:#666;">
                          <small>å†…ç½‘åœ°å€: <code id="ip-txt">-</code></small>
                      </div>
                  </div>
                  <div style="display:flex; gap:10px;">
                      <button class="cbi-button cbi-button-apply" id="login-btn" onclick="startLogin()" style="padding:10px 20px;">
                          <span style="font-weight:bold;">âš¡ ä¸€é”®ç™»å½•</span>
                      </button>
                      <button class="cbi-button cbi-button-reset" onclick="doAction('logout')" style="padding:10px 20px;">
                          æ³¨é”€
                      </button>
                      <button class="cbi-button" onclick="refresh(true)" style="padding:10px 15px;" title="åˆ·æ–°çŠ¶æ€">
                          ğŸ”„
                      </button>
                  </div>
              </div>
              
              <div id="login-modal" class="login-modal">
                  <div class="login-box">
                      <h3 style="margin-top:0; border-bottom:1px solid #eee; padding-bottom:10px;">Tailscale ç™»å½•</h3>
                      <div style="margin:20px 0;">
                          <div id="login-message" style="padding:15px; background:#f8f9fa; border-radius:5px; margin-bottom:20px;">
                              <div style="display:flex; align-items:center; gap:10px;">
                                  <span class="spinner" style="width:20px; height:20px; border:3px solid #f3f3f3; border-top:3px solid #3498db; border-radius:50%; animation:spin 1s linear infinite;"></span>
                                  <span>æ­£åœ¨ç”Ÿæˆç™»å½•é“¾æ¥ï¼Œè¯·ç¨å€™...</span>
                              </div>
                          </div>
                          
                          <div id="qr-section" style="display:none; text-align:center;">
                              <h4>è¯·æ‰«æäºŒç»´ç ç™»å½•</h4>
                              <div id="qr-container" style="margin:20px auto; background:#fff; padding:20px; border-radius:8px; display:inline-block; border:1px solid #ddd;"></div>
                              <p style="color:#666; margin-top:10px;">ä½¿ç”¨ Tailscale æ‰‹æœºå®¢æˆ·ç«¯æ‰«æäºŒç»´ç </p>
                          </div>
                          
                          <div id="link-section" style="display:none; margin-top:20px;">
                              <h4>æˆ–ç‚¹å‡»é“¾æ¥ç™»å½•</h4>
                              <div style="background:#f8f9fa; padding:15px; border-radius:5px; margin:10px 0; word-break:break-all;">
                                  <a id="auth-link" href="#" target="_blank" style="color:#0066cc; text-decoration:none; font-weight:500;">
                                      <span id="link-text">åŠ è½½ä¸­...</span>
                                  </a>
                              </div>
                              <p style="color:#666; font-size:14px;">
                                  ç‚¹å‡»ä¸Šæ–¹é“¾æ¥åœ¨æ–°çª—å£ä¸­æ‰“å¼€ç™»å½•é¡µé¢ï¼Œå®ŒæˆéªŒè¯åè¿”å›æ­¤é¡µé¢ã€‚
                              </p>
                          </div>
                          
                          <div id="status-section" style="display:none; margin-top:20px; padding:15px; background:#e8f5e8; border-radius:5px;">
                              <div style="display:flex; align-items:center; gap:10px;">
                                  <span style="color:#28a745; font-size:20px;">âœ“</span>
                                  <span id="status-message">ç™»å½•çŠ¶æ€æ£€æŸ¥ä¸­...</span>
                              </div>
                          </div>
                      </div>
                      
                      <div style="text-align:right; border-top:1px solid #eee; padding-top:20px;">
                          <button class="cbi-button" onclick="closeLoginModal()" style="padding:8px 20px;">å–æ¶ˆ</button>
                          <button id="retry-btn" class="cbi-button cbi-button-apply" onclick="generateLoginLink()" style="display:none; padding:8px 20px;">é‡è¯•</button>
                      </div>
                  </div>
              </div>
              
              <div class="device-table">
                  <table style="width:100%;">
                      <thead>
                          <tr>
                              <th style="width:35%;">è®¾å¤‡åç§°</th>
                              <th style="width:25%;">å†…ç½‘ IP</th>
                              <th style="width:25%;">ç³»ç»Ÿ / ç‰ˆæœ¬</th>
                              <th style="width:15%;">çŠ¶æ€</th>
                          </tr>
                      </thead>
                      <tbody id="dev-list">
                          <tr>
                              <td colspan="4" style="text-align:center; padding:40px; color:#999;">
                                  <div>åŠ è½½è®¾å¤‡åˆ—è¡¨ä¸­...</div>
                              </td>
                          </tr>
                      </tbody>
                  </table>
              </div>
              
              <div style="margin-top:20px; padding:15px; background:#f8f9fa; border-radius:5px; border-left:4px solid #3498db;">
                  <h4 style="margin-top:0;">ä½¿ç”¨è¯´æ˜</h4>
                  <ol style="margin-bottom:0; padding-left:20px;">
                      <li>ç‚¹å‡» <strong>ä¸€é”®ç™»å½•</strong> æŒ‰é’®å¼€å§‹ç™»å½•æµç¨‹</li>
                      <li>ä½¿ç”¨æ‰‹æœº Tailscale å®¢æˆ·ç«¯æ‰«æäºŒç»´ç ï¼Œæˆ–ç‚¹å‡»é“¾æ¥åœ¨æµè§ˆå™¨ä¸­ç™»å½•</li>
                      <li>å®Œæˆç™»å½•éªŒè¯åï¼Œè®¾å¤‡åˆ—è¡¨å°†è‡ªåŠ¨åˆ·æ–°</li>
                  </ol>
              </div>
          </div>
          
          <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
          <script>
          let loginCheckInterval = null;
          let loginModalOpen = false;
          
          // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
          document.addEventListener('DOMContentLoaded', function() {
              refresh();
              // æ¯10ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
              setInterval(() => {
                  if (!loginModalOpen) {
                      refresh();
                  }
              }, 10000);
          });
          
          async function refresh(manual = false) {
              try {
                  const response = await fetch('/cgi-bin/tailscale_api?action=status&t=' + Date.now());
                  if (!response.ok) {
                      throw new Error(`HTTP ${response.status}`);
                  }
                  const data = await response.json();
                  
                  // æ›´æ–°çŠ¶æ€
                  const statusEl = document.getElementById('st-txt');
                  const ipEl = document.getElementById('ip-txt');
                  
                  if (data.error) {
                      statusEl.textContent = 'é”™è¯¯';
                      statusEl.className = 'status-badge status-stopped';
                      ipEl.textContent = data.error;
                  } else {
                      const isRunning = data.active === 'è¿è¡Œä¸­';
                      statusEl.textContent = data.active;
                      statusEl.className = isRunning ? 'status-badge status-running' : 'status-badge status-stopped';
                      ipEl.textContent = data.ip || '-';
                      
                      // æ›´æ–°è®¾å¤‡åˆ—è¡¨
                      const devList = document.getElementById('dev-list');
                      if (data.devices && data.devices.length > 0) {
                          let html = '';
                          data.devices.forEach(device => {
                              html += `
                              <tr>
                                  <td>
                                      <strong>${escapeHtml(device.hostname || 'æœªçŸ¥')}</strong>
                                  </td>
                                  <td><code>${escapeHtml(device.ip || '-')}</code></td>
                                  <td>
                                      <div style="font-size:12px; color:#666;">${escapeHtml(device.os || '-')}</div>
                                      <div style="font-size:11px; color:#999;">${escapeHtml(device.version || '-')}</div>
                                  </td>
                                  <td>
                                      <span class="online-dot ${device.online ? 'online' : 'offline'}"></span>
                                      ${device.online ? 'åœ¨çº¿' : 'ç¦»çº¿'}
                                  </td>
                              </tr>`;
                          });
                          devList.innerHTML = html;
                      } else {
                          devList.innerHTML = `
                          <tr>
                              <td colspan="4" style="text-align:center; padding:40px; color:#999;">
                                  <div>æš‚æ— è®¾å¤‡</div>
                                  <div style="font-size:12px; margin-top:5px;">è¯·å…ˆç™»å½•ä»¥æŸ¥çœ‹è®¾å¤‡åˆ—è¡¨</div>
                              </td>
                          </tr>`;
                      }
                  }
              } catch (error) {
                  console.error('åˆ·æ–°å¤±è´¥:', error);
                  document.getElementById('st-txt').textContent = 'è¿æ¥å¤±è´¥';
                  document.getElementById('st-txt').className = 'status-badge status-stopped';
                  document.getElementById('ip-txt').textContent = 'è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥';
              }
          }
          
          function startLogin() {
              loginModalOpen = true;
              document.getElementById('login-modal').style.display = 'flex';
              generateLoginLink();
          }
          
          async function generateLoginLink() {
              // é‡ç½®UI
              document.getElementById('login-message').innerHTML = `
                  <div style="display:flex; align-items:center; gap:10px;">
                      <span class="spinner" style="width:20px; height:20px; border:3px solid #f3f3f3; border-top:3px solid #3498db; border-radius:50%; animation:spin 1s linear infinite;"></span>
                      <span>æ­£åœ¨ç”Ÿæˆç™»å½•é“¾æ¥ï¼Œè¯·ç¨å€™...</span>
                  </div>`;
              document.getElementById('qr-section').style.display = 'none';
              document.getElementById('link-section').style.display = 'none';
              document.getElementById('status-section').style.display = 'none';
              document.getElementById('retry-btn').style.display = 'none';
              
              try {
                  const response = await fetch('/cgi-bin/tailscale_api?action=login&t=' + Date.now());
                  const data = await response.json();
                  
                  if (data.result === 'ok' && data.auth_url) {
                      // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                      document.getElementById('login-message').innerHTML = `
                          <div style="color:#155724; background:#d4edda; padding:12px; border-radius:5px;">
                              <strong>âœ“ ç™»å½•é“¾æ¥å·²ç”Ÿæˆ</strong>
                              <div style="font-size:14px; margin-top:5px;">è¯·é€‰æ‹©ä»¥ä¸‹ä»»æ„ä¸€ç§æ–¹å¼å®Œæˆç™»å½•</div>
                          </div>`;
                      
                      // ç”ŸæˆäºŒç»´ç 
                      const qrContainer = document.getElementById('qr-container');
                      qrContainer.innerHTML = '';
                      QRCode.toCanvas(qrContainer, data.auth_url, { width: 200, margin: 1 }, function(error) {
                          if (error) console.error('äºŒç»´ç ç”Ÿæˆå¤±è´¥:', error);
                      });
                      document.getElementById('qr-section').style.display = 'block';
                      
                      // æ˜¾ç¤ºé“¾æ¥
                      const linkText = document.getElementById('link-text');
                      const authLink = document.getElementById('auth-link');
                      linkText.textContent = data.auth_url;
                      authLink.href = data.auth_url;
                      document.getElementById('link-section').style.display = 'block';
                      
                      // æ˜¾ç¤ºçŠ¶æ€æ£€æŸ¥
                      document.getElementById('status-section').style.display = 'block';
                      
                      // å¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€
                      startAuthCheck();
                  } else {
                      // æ˜¾ç¤ºé”™è¯¯
                      document.getElementById('login-message').innerHTML = `
                          <div style="color:#721c24; background:#f8d7da; padding:12px; border-radius:5px;">
                              <strong>âœ— ç™»å½•é“¾æ¥ç”Ÿæˆå¤±è´¥</strong>
                              <div style="font-size:14px; margin-top:5px;">${data.message || 'æœªçŸ¥é”™è¯¯'}</div>
                          </div>`;
                      document.getElementById('retry-btn').style.display = 'inline-block';
                  }
              } catch (error) {
                  console.error('è¯·æ±‚å¤±è´¥:', error);
                  document.getElementById('login-message').innerHTML = `
                      <div style="color:#721c24; background:#f8d7da; padding:12px; border-radius:5px;">
                          <strong>âœ— è¯·æ±‚å¤±è´¥</strong>
                          <div style="font-size:14px; margin-top:5px;">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•</div>
                      </div>`;
                  document.getElementById('retry-btn').style.display = 'inline-block';
              }
          }
          
          function startAuthCheck() {
              if (loginCheckInterval) clearInterval(loginCheckInterval);
              
              let checkCount = 0;
              const maxChecks = 60; // æœ€å¤šæ£€æŸ¥60æ¬¡ï¼ˆ2åˆ†é’Ÿï¼‰
              
              loginCheckInterval = setInterval(async () => {
                  checkCount++;
                  
                  try {
                      const response = await fetch('/cgi-bin/tailscale_api?action=auth_check&t=' + Date.now());
                      const data = await response.json();
                      
                      if (data.authenticated) {
                          document.getElementById('status-message').innerHTML = `
                              <strong style="color:#155724;">âœ“ ç™»å½•æˆåŠŸï¼</strong>
                              <div style="font-size:14px; margin-top:5px;">æ­£åœ¨åˆ·æ–°è®¾å¤‡åˆ—è¡¨...</div>`;
                          
                          clearInterval(loginCheckInterval);
                          loginCheckInterval = null;
                          
                          // ç­‰å¾…2ç§’åå…³é—­æ¨¡æ€æ¡†å¹¶åˆ·æ–°
                          setTimeout(() => {
                              closeLoginModal();
                              refresh();
                          }, 2000);
                          
                          return;
                      }
                      
                      // æ›´æ–°çŠ¶æ€æ¶ˆæ¯
                      const minutes = Math.floor(checkCount * 2 / 60);
                      const seconds = (checkCount * 2) % 60;
                      document.getElementById('status-message').innerHTML = `
                          <div>
                              <strong>ç­‰å¾…ç™»å½•éªŒè¯...</strong>
                              <div style="font-size:14px; margin-top:5px;">
                                  å·²ç­‰å¾… ${minutes}åˆ†${seconds}ç§’ï¼Œè¯·å®Œæˆç™»å½•éªŒè¯
                              </div>
                          </div>`;
                      
                      // è¶…è¿‡æœ€å¤§æ£€æŸ¥æ¬¡æ•°åˆ™åœæ­¢
                      if (checkCount >= maxChecks) {
                          clearInterval(loginCheckInterval);
                          loginCheckInterval = null;
                          document.getElementById('status-message').innerHTML = `
                              <div style="color:#721c24;">
                                  <strong>âœ— ç™»å½•è¶…æ—¶</strong>
                                  <div style="font-size:14px; margin-top:5px;">è¯·é‡æ–°ç”Ÿæˆç™»å½•é“¾æ¥</div>
                              </div>`;
                          document.getElementById('retry-btn').style.display = 'inline-block';
                      }
                  } catch (error) {
                      console.error('çŠ¶æ€æ£€æŸ¥å¤±è´¥:', error);
                  }
              }, 2000); // æ¯2ç§’æ£€æŸ¥ä¸€æ¬¡
          }
          
          function closeLoginModal() {
              loginModalOpen = false;
              document.getElementById('login-modal').style.display = 'none';
              if (loginCheckInterval) {
                  clearInterval(loginCheckInterval);
                  loginCheckInterval = null;
              }
          }
          
          async function doAction(action) {
              if (action === 'logout' && !confirm('ç¡®å®šè¦æ³¨é”€ Tailscale å—ï¼Ÿ')) {
                  return;
              }
              
              try {
                  await fetch(`/cgi-bin/tailscale_api?action=${action}&t=${Date.now()}`);
                  refresh();
                  if (action === 'logout') {
                      alert('æ³¨é”€æˆåŠŸ');
                  }
              } catch (error) {
                  console.error('æ“ä½œå¤±è´¥:', error);
                  alert('æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
              }
          }
          
          function escapeHtml(text) {
              const div = document.createElement('div');
              div.textContent = text;
              return div.innerHTML;
          }
          
          // æ·»åŠ CSSåŠ¨ç”»
          const style = document.createElement('style');
          style.textContent = `
          @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
          }
          .spinner {
              animation: spin 1s linear infinite;
          }
          `;
          document.head.appendChild(style);
          </script>
          <%+footer%>
          EOF

      - name: Create Controller
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/controller/tailscale_web.lua
          module("luci.controller.tailscale_web", package.seeall)
          function index()
              entry({"admin", "services", "tailscale_web"}, template("tailscale_web/index"), _("Tailscale"), 99)
          end
          EOF

      - name: Build Package
        run: |
          cp shell/install-tailscale.sh staging/install.sh
          chmod +x staging/install.sh
          makeself --notemp staging "tailscale-${{ steps.v.outputs.tag }}-x86.run" "Tailscale" ./install.sh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ steps.v.outputs.tag }}"
          name: "Tailscale-Console-v${{ steps.v.outputs.tag }}"
          files: "*.run"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
