name: Build Tailscale

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare
        run: sudo apt-get update && sudo apt-get install -y makeself jq curl

      - name: Get Files
        run: |
          VERSION=$(curl -sL https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r ".tag_name" | sed 's/v//')
          curl -fSL "https://pkgs.tailscale.com/stable/tailscale_${VERSION}_amd64.tgz" -o ts.tgz
          tar xzf ts.tgz
          mkdir -p staging/bin staging/usr/lib/lua/luci/controller/ staging/usr/lib/lua/luci/view/tailscale_web/ staging/www/cgi-bin/
          mv tailscale_*/tailscale staging/bin/
          mv tailscale_*/tailscaled staging/bin/
          echo "$VERSION" > version.txt

      - name: Create API
        run: |
          cat << 'EOF' > staging/www/cgi-bin/tailscale_api
          #!/bin/sh
          echo "Content-type: application/json"
          echo ""
          TS="/bin/tailscale"
          case "$QUERY_STRING" in
            *action=status*)
              ST=$(timeout 2 $TS status --json 2>/dev/null)
              if [ -z "$ST" ]; then
                URL=$(timeout 2 $TS up --accept-dns=false --reset 2>&1 | grep -o 'https://login.tailscale.com/a/[^ ]*' | head -n 1)
                echo "{\"active\": \"æœªç™»å½•\", \"url\": \"$URL\"}"
              else
                IP=$(echo "$ST" | jq -r '.Self.TailscaleIPs[0] // "-"')
                echo "{\"active\": \"è¿è¡Œä¸­\", \"ip\": \"$IP\"}"
              fi ;;
            *action=logout*) $TS logout >/dev/null 2>&1; echo "{\"result\": \"ok\"}" ;;
          esac
          EOF
          chmod 755 staging/www/cgi-bin/tailscale_api

      - name: Create UI
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/view/tailscale_web/index.htm
          <%+header%>
          <div class="cbi-map">
            <h2>Tailscale æ§åˆ¶é¢æ¿</h2>
            <div id="auth-box" style="display:none; background:#fffbe6; padding:20px; border:1px solid #ffe58f; margin-bottom:20px; text-align:center;">
              <p id="msg">æ­£åœ¨å‡†å¤‡æˆæƒé“¾æ¥...</p>
              <a id="btn" href="#" target="_blank" style="display:none; padding:10px 20px; background:#1890ff; color:#fff; text-decoration:none; font-weight:bold; border-radius:4px;">ğŸ‘‰ ç‚¹å‡»å‰å¾€å®˜ç½‘ç™»å½• ğŸ‘ˆ</a>
            </div>
            <div style="background:#fff; padding:15px; border:1px solid #ddd; display:flex; justify-content:space-between; align-items:center;">
              <div>çŠ¶æ€: <span id="st">åˆå§‹åŒ–...</span><br>IP: <span id="ip">-</span></div>
              <button class="cbi-button cbi-button-reset" onclick="fetch('/cgi-bin/tailscale_api?action=logout').then(()=>location.reload())">é€€å‡ºç™»å½•</button>
            </div>
          </div>
          <script>
            function refresh() {
              fetch('/cgi-bin/tailscale_api?action=status').then(r => r.json()).then(d => {
                document.getElementById('st').innerText = d.active;
                document.getElementById('st').style.color = (d.active === "è¿è¡Œä¸­") ? "green" : "red";
                document.getElementById('ip').innerText = d.ip || "-";
                if (d.active === "æœªç™»å½•") {
                  document.getElementById('auth-box').style.display = 'block';
                  if(d.url){ 
                    document.getElementById('btn').style.display='inline-block'; 
                    document.getElementById('btn').href=d.url;
                    document.getElementById('msg').innerText="è¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç™»å½•ï¼š";
                  }
                } else { document.getElementById('auth-box').style.display = 'none'; }
              });
            }
            setInterval(refresh, 5000); refresh();
          </script>
          <%+footer%>
          EOF

      - name: Create Controller
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/controller/tailscale_web.lua
          module("luci.controller.tailscale_web", package.seeall)
          function index()
            entry({"admin", "services", "tailscale_web"}, template("tailscale_web/index"), _("Tailscale"), 99)
          end
          EOF

      - name: Build
        run: |
          VER=$(cat version.txt)
          cp shell/install-tailscale.sh staging/install.sh
          chmod +x staging/install.sh
          makeself staging "tailscale-${VER}.run" "Tailscale" ./install.sh

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ github.run_number }}"
          files: "*.run"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
