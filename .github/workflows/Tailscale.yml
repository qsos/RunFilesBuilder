name: build-tailscale-run

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Prepare staging
        run: |
          mkdir -p staging/www/cgi-bin
          mkdir -p staging/usr/lib/lua/luci/view/tailscale_web

      - name: Create tailscale_api
        run: |
          cat << 'EOF' > staging/www/cgi-bin/tailscale_api
          #!/bin/sh
          echo "Content-type: application/json"
          echo ""
          TS="/bin/tailscale"
          case "$QUERY_STRING" in
            *action=status*)
              ST=$($TS status --json 2>/dev/null)
              ACTIVE=$(echo "$ST" | jq -r '.BackendState // "未运行"')
              if [ "$ACTIVE" != "Running" ]; then
                URL=$($TS up --accept-dns=false --reset 2>&1 | grep -o 'https://login.tailscale.com/a/[^ ]*')
                echo "{\"active\":\"未登录\",\"url\":\"$URL\",\"devices\":[]}"
              else
                IP=$(echo "$ST" | jq -r '.Self.TailscaleIPs[0] // "-"')
                DEVICES=$(echo "$ST" | jq -c '.Peer | to_entries | map({hostname:.value.HostName,ip:(.value.TailscaleIPs[0]//\"-\"),online:.value.Online})')
                echo "{\"active\":\"运行中\",\"ip\":\"$IP\",\"devices\":$DEVICES}"
              fi
            ;;
            *action=logout*)
              $TS logout >/dev/null 2>&1
              echo "{\"result\":\"ok\"}"
            ;;
          esac
          EOF
          chmod 755 staging/www/cgi-bin/tailscale_api

      - name: Create LuCI view (fix 404)
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/view/tailscale_web/index.htm
          <%+header%>
          <div class="cbi-map">
            <h2>Tailscale 控制面板</h2>
            <div id="auth-box" style="display:none">
              <a id="auth-link" href="#" target="_blank">授权</a>
            </div>
          </div>
          <script>
            function refresh(){
              fetch('/cgi-bin/luci/tailscale_api?action=status')
                .then(r=>r.json())
                .then(d=>{
                  if(d.active==='未登录' && d.url){
                    document.getElementById('auth-box').style.display='block';
                    document.getElementById('auth-link').href=d.url;
                  }
                });
            }
            refresh();
          </script>
          <%+footer%>
          EOF

      - name: Pack result
        run: |
          cd staging
          tar czf ../tailscale-files.tar.gz .
          ls -lh ../tailscale-files.tar.gz

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-files
          path: tailscale-files.tar.gz
