name: Build Tailscale Advanced Console

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Tools
        run: sudo apt-get update && sudo apt-get install -y makeself jq curl

      - name: Download Binary
        id: v
        run: |
          VERSION=$(curl -sL https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r ".tag_name" | sed 's/v//')
          curl -fSL "https://pkgs.tailscale.com/stable/tailscale_${VERSION}_amd64.tgz" -o ts.tgz
          tar xzf ts.tgz
          mkdir -p staging/bin staging/usr/lib/lua/luci/controller/ staging/usr/lib/lua/luci/view/tailscale_web/ staging/www/cgi-bin/
          mv tailscale_*/tailscale staging/bin/
          mv tailscale_*/tailscaled staging/bin/
          echo "tag=$VERSION" >> $GITHUB_OUTPUT

      - name: Create Backend API
        run: |
          cat << 'EOF' > staging/www/cgi-bin/tailscale_api
          #!/bin/sh
          echo "Content-type: application/json"
          echo ""
          TS="/bin/tailscale"
          case "$QUERY_STRING" in
              action=status)
                  ST=$($TS status --json 2>/dev/null)
                  ACTIVE=$(echo "$ST" | jq -r '.BackendState // "æœªè¿è¡Œ"')
                  if [ "$ACTIVE" != "Running" ]; then
                      URL=$($TS up --accept-dns=false --reset 2>&1 | grep -o 'https://login.tailscale.com/a/[^ ]*')
                      echo "{\"active\": \"æœªç™»å½•\", \"url\": \"$URL\", \"devices\": []}"
                  else
                      IP=$(echo "$ST" | jq -r '.Self.TailscaleIPs[0] // "-"')
                      DEVICES=$(echo "$ST" | jq -c '.Peer | to_entries | map({hostname: .value.HostName, ip: (.value.TailscaleIPs[0] // "-"), online: .value.Online})')
                      echo "{\"active\": \"è¿è¡Œä¸­\", \"ip\": \"$IP\", \"devices\": $DEVICES}"
                  fi ;;
              action=logout) $TS logout >/dev/null 2>&1; echo "{\"result\": \"ok\"}" ;;
          esac
          EOF
          chmod 755 staging/www/cgi-bin/tailscale_api

      - name: Create UI (å¸¦é“¾æ¥æŠ“å–åŠŸèƒ½)
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/view/tailscale_web/index.htm
          <%+header%>
          <div class="cbi-map">
              <h2 style="margin-bottom:20px">Tailscale æ§åˆ¶é¢æ¿</h2>
              <div id="auth-box" style="display:none; background:#fffbe6; padding:15px; border:1px solid #ffe58f; border-radius:4px; margin-bottom:20px;">
                  <strong style="color:#856404;">æˆæƒæé†’ï¼š</strong>
                  <p>æ£€æµ‹åˆ°æœªç™»å½•ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹é“¾æ¥å®Œæˆæˆæƒï¼ˆæ— éœ€ SSHï¼‰ï¼š</p>
                  <a id="auth-link" href="#" target="_blank" style="word-break:break-all; font-weight:bold; color:#1890ff; font-size:14px;">æ­£åœ¨è·å–æˆæƒé“¾æ¥...</a>
              </div>
              <div style="background:#fff; padding:15px; border:1px solid #ddd; border-radius:4px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                  <div><strong>çŠ¶æ€:</strong> <span id="st-txt">åŒæ­¥ä¸­...</span><br><small id="ip-txt" style="color:#888">åœ°å€: -</small></div>
                  <button class="cbi-button cbi-button-reset" onclick="fetch('/cgi-bin/tailscale_api?action=logout');location.reload();">æ³¨é”€æœåŠ¡</button>
              </div>
              <table class="cbi-section-table" style="width:100%; table-layout:fixed; border:1px solid #eee;">
                  <thead>
                      <tr class="cbi-section-table-titles">
                          <th class="cbi-section-table-cell" style="width:40%; text-align:left; padding:10px;">è®¾å¤‡</th>
                          <th class="cbi-section-table-cell" style="width:30%; text-align:left; padding:10px;">å†…ç½‘ IP</th>
                          <th class="cbi-section-table-cell" style="width:30%; text-align:left; padding:10px;">çŠ¶æ€</th>
                      </tr>
                  </thead>
                  <tbody id="dev-list"></tbody>
              </table>
          </div>
          <script>
              function refresh() {
                  fetch('/cgi-bin/tailscale_api?action=status').then(r => r.json()).then(d => {
                      const st = document.getElementById('st-txt');
                      const abox = document.getElementById('auth-box');
                      const alink = document.getElementById('auth-link');
                      st.innerText = d.active;
                      st.style.color = (d.active === "è¿è¡Œä¸­") ? "#28a745" : "#ff4d4f";
                      document.getElementById('ip-txt').innerText = "åœ°å€: " + (d.ip || "-");
                      if (d.active === "æœªç™»å½•" && d.url) {
                          abox.style.display = 'block';
                          alink.href = d.url;
                          alink.innerText = "ğŸ‘‰ ç‚¹å‡»è¿™é‡Œæˆæƒæ­¤è®¾å¤‡";
                      } else {
                          abox.style.display = 'none';
                      }
                      let h = '';
                      if(d.devices && d.devices.length > 0) {
                          d.devices.forEach(v => {
                              h += '<tr><td style="padding:10px;">'+v.hostname+'</td><td style="padding:10px;">'+v.ip+'</td><td style="padding:10px;">'+(v.online?"åœ¨çº¿":"ç¦»çº¿")+'</td></tr>';
                          });
                      } else { h = '<tr><td colspan="3" style="text-align:center;padding:20px;color:#999;">æ— åœ¨çº¿è®¾å¤‡</td></tr>'; }
                      document.getElementById('dev-list').innerHTML = h;
                  });
              }
              refresh(); setInterval(refresh, 5000);
          </script>
          <%+footer%>
          EOF

      - name: Create Controller
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/controller/tailscale_web.lua
          module("luci.controller.tailscale_web", package.seeall)
          function index()
              entry({"admin", "services", "tailscale_web"}, template("tailscale_web/index"), _("Tailscale"), 99)
          end
          EOF

      - name: Build Package
        run: |
          cp shell/install-tailscale.sh staging/install.sh
          chmod +x staging/install.sh
          makeself staging "tailscale-setup.run" "Tailscale" ./install.sh

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ github.run_number }}"
          files: "*.run"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
