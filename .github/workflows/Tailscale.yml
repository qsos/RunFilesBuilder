#=================================================
# Build Tailscale GUI RunFiles (iStoreOS / OpenWrt)
#=================================================
name: Make Tailscale GUI run files

on:
  workflow_dispatch:

jobs:
  make-run:
    runs-on: ubuntu-22.04

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: sudo apt-get update && sudo apt-get install -y makeself curl

      - name: ğŸš€ å‡†å¤‡ x86_64 æ–‡ä»¶
        run: |
          set -e

          mkdir -p x86_64
          cd x86_64

          echo "â¬‡ï¸ ä¸‹è½½ LuCI Tailscale Community GUI"
          curl -fL \
            https://dl.openwrt.ai/packages-24.10/x86_64/kiddin9/luci-app-tailscale-community_26.341.56069~77a6686_all.ipk \
            -o luci-app-tailscale-community.ipk

          echo "â¬‡ï¸ ä¸‹è½½ tailscale æ ¸å¿ƒï¼ˆäºŒè¿›åˆ¶ï¼‰"
          curl -fL \
            https://pkgs.tailscale.com/stable/tailscale_1.90.2_amd64.tgz \
            -o tailscale.tgz

          tar zxvf tailscale.tgz
          mv tailscale_1.90.2_amd64/tailscale .
          mv tailscale_1.90.2_amd64/tailscaled .

          chmod +x tailscale tailscaled
          rm -rf tailscale_1.90.2_amd64 tailscale.tgz

      - name: ğŸ“‹ æ”¾ç½® install.sh
        run: |
          cp shell/install.sh x86_64/install.sh
          chmod +x x86_64/install.sh

      - name: ğŸ“¦ æ‰“åŒ… run æ–‡ä»¶
        run: |
          mkdir -p output
          makeself x86_64 \
            output/tailscale-gui-community_x86_64.run \
            "Tailscale GUI Community Installer (x86_64)" \
            ./install.sh

      - name: ğŸ“¤ ä¸Šä¼  Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "tailscale-gui-community"
          name: "tailscale-gui-community"
          files: output/*.run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
