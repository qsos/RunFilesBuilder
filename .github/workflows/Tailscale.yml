name: Build Tailscale Advanced Console

on:
  workflow_dispatch:
    inputs:
      version:
        description: '指定版本 (留空则自动获取最新)'
        required: false
        default: ''
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    strategy:
      matrix:
        include:
          - arch: amd64
            output_name: x86
          - arch: arm64
            output_name: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Tools
        run: sudo apt-get update && sudo apt-get install -y makeself jq curl

      - name: Determine Version
        id: meta
        run: |
          if [ -z "${{ github.event.inputs.version }}" ]; then
            # 自动获取官方最新版本号
            VERSION=$(curl -sL https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r ".tag_name" | sed 's/v//')
          else
            VERSION=${{ github.event.inputs.version }}
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building Tailscale Version: $VERSION"

      - name: Download and Prepare Staging
        run: |
          VERSION=${{ steps.meta.outputs.version }}
          curl -fSL "https://pkgs.tailscale.com/stable/tailscale_${VERSION}_${{ matrix.arch }}.tgz" -o tailscale.tgz
          tar xzf tailscale.tgz
          mkdir -p staging/bin staging/usr/lib/lua/luci/controller/ staging/usr/lib/lua/luci/view/tailscale_web/ staging/www/cgi-bin/
          mv tailscale_*/tailscale staging/bin/
          mv tailscale_*/tailscaled staging/bin/
          rm -rf tailscale.tgz tailscale_*

      - name: Create Backend API
        run: |
          cat << 'EOF' > staging/www/cgi-bin/tailscale_api
          #!/bin/sh
          echo "Content-type: application/json"
          echo ""
          case "$QUERY_STRING" in
              *action=status*)
                  ST=$(/usr/sbin/tailscale status --json 2>/dev/null)
                  if [ $? -ne 0 ]; then
                      echo "{\"active\": \"Stopped\"}"
                  else
                      BACKEND=$(echo "$ST" | jq -r '.BackendState')
                      IP=$(echo "$ST" | jq -r '.TailscaleIPs[0] // "-"')
                      AUTH=$(echo "$ST" | jq -r '.AuthURL // ""')
                      DEVICES=$(echo "$ST" | jq -c '.Peer | to_entries | map({hostname: .value.HostName, ip: .value.TailscaleIPs[0], os: .value.OS, online: .value.Online})')
                      echo "{\"active\": \"$BACKEND\", \"ip\": \"$IP\", \"url\": \"$AUTH\", \"devices\": $DEVICES}"
                  fi
                  ;;
              *action=login*)
                  /usr/sbin/tailscale up --accept-dns=false --reset >/dev/null 2>&1 &
                  echo "{\"result\": \"success\"}"
                  ;;
              *action=logout*)
                  /usr/sbin/tailscale logout >/dev/null 2>&1
                  echo "{\"result\": \"success\"}"
                  ;;
              *action=expiry_on*)
                  /usr/sbin/tailscale up --reset --reset-node-key >/dev/null 2>&1 &
                  echo "{\"result\": \"expiry_reset\"}"
                  ;;
              *action=subnet_on*)
                  LAN_NET=$(uci get network.lan.ipaddr | cut -d. -f1-3).0/24
                  /usr/sbin/tailscale up --advertise-routes=$LAN_NET --reset >/dev/null 2>&1 &
                  echo "{\"result\": \"subnet_enabled\", \"route\": \"$LAN_NET\"}"
                  ;;
              *action=subnet_off*)
                  /usr/sbin/tailscale up --advertise-routes= --reset >/dev/null 2>&1 &
                  echo "{\"result\": \"subnet_disabled\"}"
                  ;;
          esac
          EOF
          chmod 755 staging/www/cgi-bin/tailscale_api

      - name: Create Console UI
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/view/tailscale_web/index.htm
          <%+header%>
          <div class="cbi-map">
              <h2 name="content">Tailscale 高级控制台</h2>
              <fieldset class="cbi-section">
                  <legend>系统状态</legend>
                  <div style="padding:15px; background:#f4f4f4; border:1px solid #ccc;">
                      <p>节点状态: <b id="ts-status">获取中...</b> | 我的 IP: <b id="ts-ip">-</b></p>
                      <div style="margin-top:10px;">
                          <button class="cbi-button cbi-button-apply" onclick="doAct('login')">登录上线</button>
                          <button class="cbi-button cbi-button-reset" onclick="doAct('logout')">完全退出</button>
                          <button class="cbi-button" onclick="doAct('subnet_on')">开启子网</button>
                          <button class="cbi-button" onclick="doAct('subnet_off')">关闭子网</button>
                          <button class="cbi-button" onclick="doAct('expiry_on')">强制过期</button>
                      </div>
                      <div id="login-box" style="display:none; margin-top:10px; color: red;">
                          授权链接: <a id="ts-url" href="#" target="_blank">点击此处登录</a>
                      </div>
                  </div>
              </fieldset>
              <fieldset class="cbi-section">
                  <legend>网络设备列表</legend>
                  <table style="width:100%; border-collapse:collapse;" id="dev-table">
                      <thead>
                          <tr style="background:#eee; text-align:left;">
                              <th style="padding:8px; border:1px solid #ddd;">名称</th>
                              <th style="padding:8px; border:1px solid #ddd;">IP</th>
                              <th style="padding:8px; border:1px solid #ddd;">系统</th>
                              <th style="padding:8px; border:1px solid #ddd;">状态</th>
                          </tr>
                      </thead>
                      <tbody></tbody>
                  </table>
              </fieldset>
          </div>
          <script>
              function refresh() {
                  fetch('/cgi-bin/tailscale_api?action=status').then(r => r.json()).then(d => {
                      document.getElementById('ts-status').innerText = d.active;
                      document.getElementById('ts-status').style.color = d.active === "Running" ? "green" : "red";
                      document.getElementById('ts-ip').innerText = d.ip;
                      if(d.url) {
                          document.getElementById('login-box').style.display = 'block';
                          document.getElementById('ts-url').href = d.url;
                      } else {
                          document.getElementById('login-box').style.display = 'none';
                      }
                      const tbody = document.querySelector('#dev-table tbody');
                      tbody.innerHTML = '';
                      if(d.devices) {
                          d.devices.forEach(dev => {
                              tbody.innerHTML += `<tr>
                                  <td style="padding:8px; border:1px solid #ddd;">${dev.hostname}</td>
                                  <td style="padding:8px; border:1px solid #ddd;">${dev.ip}</td>
                                  <td style="padding:8px; border:1px solid #ddd;">${dev.os}</td>
                                  <td style="padding:8px; border:1px solid #ddd; color:${dev.online?'green':'#999'}">${dev.online?'● 在线':'○ 离线'}</td>
                              </tr>`;
                          });
                      }
                  });
              }
              function doAct(a) { fetch('/cgi-bin/tailscale_api?action=' + a); setTimeout(refresh, 3000); }
              setInterval(refresh, 8000); refresh();
          </script>
          <%+footer%>
          EOF

      - name: Create LuCI Controller
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/controller/tailscale_web.lua
          module("luci.controller.tailscale_web", package.seeall)
          function index()
              entry({"admin", "services", "tailscale_web"}, template("tailscale_web/index"), _("Tailscale Console"), 99)
          end
          EOF

      - name: Final Build
        run: |
          VERSION=${{ steps.meta.outputs.version }}
          ARCH_NAME=${{ matrix.output_name }}
          cp shell/install-tailscale.sh staging/install.sh
          chmod +x staging/install.sh
          # 关键修改：文件名现在包含版本号
          makeself --notemp staging "tailscale-${VERSION}-${ARCH_NAME}.run" "Tailscale ${VERSION} Console" ./install.sh

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ steps.meta.outputs.version }}"
          name: "Tailscale v${{ steps.meta.outputs.version }} Console"
          files: "tailscale-*.run"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
