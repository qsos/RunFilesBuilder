name: Build Tailscale Advanced Console

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare Tools
        run: sudo apt-get update && sudo apt-get install -y makeself jq curl

      - name: Download Binary
        run: |
          VERSION=$(curl -sL https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r ".tag_name" | sed 's/v//')
          curl -fSL "https://pkgs.tailscale.com/stable/tailscale_${VERSION}_amd64.tgz" -o ts.tgz
          tar xzf ts.tgz

          mkdir -p staging/bin
          mkdir -p staging/www/cgi-bin
          mkdir -p staging/usr/lib/lua/luci/controller
          mkdir -p staging/usr/lib/lua/luci/view/tailscale_web

          mv tailscale_*/tailscale staging/bin/
          mv tailscale_*/tailscaled staging/bin/

      - name: Create CGI API
        run: |
          cat << 'EOF' > staging/www/cgi-bin/tailscale_api
          #!/bin/sh
          echo "Content-type: application/json"
          echo ""

          TS=/bin/tailscale

          case "$QUERY_STRING" in
            *status*)
              ST=$($TS status --json 2>/dev/null)
              if [ -z "$ST" ]; then
                echo '{"active":"未运行","ip":"-"}'
              else
                IP=$(echo "$ST" | jq -r '.Self.TailscaleIPs[0] // "-"')
                echo "{\"active\":\"运行中\",\"ip\":\"$IP\"}"
              fi
              ;;
            *login*)
              $TS up --accept-dns=false >/dev/null 2>&1 &
              echo '{"result":"ok"}'
              ;;
            *logout*)
              $TS logout >/dev/null 2>&1
              echo '{"result":"ok"}'
              ;;
          esac
          EOF
          chmod +x staging/www/cgi-bin/tailscale_api

      - name: Create LuCI Controller
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/controller/tailscale_web.lua
          module("luci.controller.tailscale_web", package.seeall)

          function index()
            entry({"admin","services","tailscale_web"},
                  template("tailscale_web/index"),
                  _("Tailscale"), 99)
          end
          EOF

      - name: Create LuCI Page
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/view/tailscale_web/index.htm
          <%+header%>
          <h2>Tailscale</h2>
          <div>
            <p>状态：<span id="st">检测中</span></p>
            <p>IP：<span id="ip">-</span></p>
            <button onclick="act('login')">登录</button>
            <button onclick="act('logout')">注销</button>
          </div>

          <script>
          function refresh(){
            fetch('/cgi-bin/tailscale_api?status=1')
              .then(r=>r.json())
              .then(d=>{
                document.getElementById('st').innerText=d.active;
                document.getElementById('ip').innerText=d.ip;
              });
          }
          function act(a){
            fetch('/cgi-bin/tailscale_api?'+a+'=1');
            setTimeout(refresh,2000);
          }
          refresh();
          </script>
          <%+footer%>
          EOF

      - name: Build RUN
        run: |
          cp shell/install-tailscale.sh staging/install.sh
          chmod +x staging/install.sh
          makeself staging tailscale.run "Tailscale" ./install.sh

      - name: Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.run_number }}
          files: tailscale.run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
