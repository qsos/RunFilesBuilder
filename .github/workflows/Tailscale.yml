name: Build Tailscale RunFile

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create directory
        run: |
          mkdir -p staging/bin staging/www/cgi-bin staging/usr/lib/lua/luci/controller staging/usr/lib/lua/luci/view/tailscale_web

      - name: Create Backend API
        run: |
          cat << 'EOF' > staging/www/cgi-bin/tailscale_api
          #!/bin/sh
          echo "Content-type: application/json"
          echo ""
          TS="/bin/tailscale"
          case "$QUERY_STRING" in
              *action=status*)
                  ST=$($TS status --json 2>/dev/null)
                  ACTIVE=$(echo "$ST" | jq -r '.BackendState // "未运行"')
                  if [ "$ACTIVE" != "Running" ]; then
                      URL=$($TS up --accept-dns=false --reset 2>&1 | grep -o 'https://login.tailscale.com/a/[^ ]*')
                      echo "{\"active\": \"未登录\", \"url\": \"$URL\", \"devices\": []}"
                  else
                      IP=$(echo "$ST" | jq -r '.Self.TailscaleIPs[0] // "-"')
                      DEVICES=$(echo "$ST" | jq -c '.Peer | to_entries | map({hostname: .value.HostName, ip: (.value.TailscaleIPs[0] // "-"), online: .value.Online})')
                      echo "{\"active\": \"运行中\", \"ip\": \"$IP\", \"devices\": $DEVICES}"
                  fi ;;
              *action=logout*)
                  $TS logout >/dev/null 2>&1; echo "{\"result\": \"ok\"}" ;;
          esac
          EOF
          chmod 755 staging/www/cgi-bin/tailscale_api

      - name: Create UI (带授权检测)
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/view/tailscale_web/index.htm
          <%+header%>
          <div class="cbi-map">
            <h2>Tailscale 控制面板</h2>
            <div id="auth-box" style="display:none;padding:15px;background:#fffbe6;border:1px solid #ffe58f;border-radius:4px;margin-bottom:20px;">
              <strong>授权提醒：</strong>
              <p>检测到未登录，请点击下方链接完成授权：</p>
              <a id="auth-link" href="#" target="_blank">正在获取授权链接...</a>
            </div>
            <div style="background:#fff;padding:15px;border:1px solid #ddd;border-radius:4px;margin-bottom:20px;display:flex;justify-content:space-between;align-items:center;">
              <div><strong>状态:</strong> <span id="st-txt">同步中...</span><br><small id="ip-txt">地址: -</small></div>
              <button class="cbi-button cbi-button-reset" onclick="fetch('/cgi-bin/luci/tailscale_api?action=logout');location.reload();">注销服务</button>
            </div>
            <table class="cbi-section-table" style="width:100%;">
              <thead><tr><th>设备</th><th>内网 IP</th><th>状态</th></tr></thead>
              <tbody id="dev-list"></tbody>
            </table>
          </div>
          <script>
            function refresh() {
              fetch('/cgi-bin/luci/tailscale_api?action=status').then(r=>r.json()).then(d=>{
                document.getElementById('st-txt').innerText=d.active;
                document.getElementById('ip-txt').innerText='地址: '+(d.ip||'-');
                const abox=document.getElementById('auth-box');
                const alink=document.getElementById('auth-link');
                if(d.active==='未登录'&&d.url){
                  abox.style.display='block';
                  alink.href=d.url;
                  alink.innerText='点击此处授权';
                }else abox.style.display='none';
                let h='';
                if(d.devices&&d.devices.length){
                  d.devices.forEach(v=>{
                    h+=`<tr><td>${v.hostname}</td><td>${v.ip}</td><td>${v.online?'在线':'离线'}</td></tr>`;
                  });
                }else h='<tr><td colspan="3">暂无节点</td></tr>';
                document.getElementById('dev-list').innerHTML=h;
              });
            }
            refresh(); setInterval(refresh,5000);
          </script>
          <%+footer%>
          EOF

      - name: Package RunFile
        run: |
          mkdir -p output
          tar czf output/tailscale.run.tar.gz -C staging .
          echo "✅ Build complete: output/tailscale.run.tar.gz"
