name: Build and Install Tailscale

on:
  workflow_dispatch:

jobs:
  build-tailscale:
    runs-on: ubuntu-22.04

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Install necessary dependencies
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl make gcc g++ git

      # Step 3: Download and extract Tailscale source code
      - name: Download Tailscale
        run: |
          curl -L https://github.com/tailscale/tailscale/archive/refs/tags/v1.92.3.tar.gz -o tailscale-1.92.3.tar.gz
          tar -xzf tailscale-1.92.3.tar.gz

      # Step 4: Build Tailscale
      - name: Build Tailscale
        run: |
          cd tailscale-1.92.3
          make

      # Step 5: Package into a .run file
      - name: Package Tailscale into .run file
        run: |
          mkdir -p output
          makeself ./tailscale-1.92.3 output/tailscale-1.92.3.run "Tailscale Installer v1.92.3" ./install.sh

      # Step 6: Upload .run file to GitHub Release
      - name: Upload .run file to release
        uses: softprops/action-gh-release@v2.1.0
        with:
          tag_name: "v1.92.3"
          name: "Tailscale v1.92.3"
          files: output/*.run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
