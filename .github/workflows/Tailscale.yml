name: Make Tailscale GUI run files

on:
  workflow_dispatch:

jobs:
  make-run:
    runs-on: ubuntu-22.04

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v3

      - name: ðŸ“¦ å®‰è£… makeself
        run: sudo apt-get update && sudo apt-get install -y makeself curl

      - name: ðŸš€ å‡†å¤‡ tailscale GUI æ–‡ä»¶
        run: |
          set -e

          # å¹³å°ç›®å½•
          mkdir -p x86_64/usr/sbin
          mkdir -p x86_64/etc/init.d
          mkdir -p x86_64/etc/config
          mkdir -p x86_64/usr/lib/lua/luci/controller
          mkdir -p x86_64/usr/lib/lua/luci/model/cbi

          # ä¸‹è½½æœ€æ–°ç‰ˆ tailscale
          curl -fsSL https://pkgs.tailscale.com/stable/tailscale-linux-amd64.tgz -o ts.tgz
          tar zxvf ts.tgz
          TS=$(ls -d tailscale_*_amd64)

          cp $TS/tailscale x86_64/usr/sbin/
          cp $TS/tailscaled x86_64/usr/sbin/
          chmod +x x86_64/usr/sbin/*

          # init.d
          cat > x86_64/etc/init.d/tailscale << 'EOF'
          #!/bin/sh /etc/rc.common
          START=99
          STOP=10
          USE_PROCD=1
          start_service() {
              procd_open_instance
              procd_set_param command /usr/sbin/tailscaled --state=/var/lib/tailscale/tailscaled.state
              procd_set_param respawn
              procd_close_instance
          }
          stop_service() {
              killall tailscaled 2>/dev/null
          }
          EOF
          chmod +x x86_64/etc/init.d/tailscale

          # UCI
          cat > x86_64/etc/config/tailscale << 'EOF'
          config tailscale 'main'
              option enabled '0'
              option authkey ''
              option accept_routes '1'
          EOF

          # LuCI controller
          cat > x86_64/usr/lib/lua/luci/controller/tailscale.lua << 'EOF'
          module("luci.controller.tailscale", package.seeall)
          function index()
              entry({"admin","services","tailscale"}, cbi("tailscale"), _("Tailscale"), 90)
          end
          EOF

          # LuCI page
          cat > x86_64/usr/lib/lua/luci/model/cbi/tailscale.lua << 'EOF'
          local sys = require "luci.sys"
          local uci = require "luci.model.uci".cursor()
          m = Map("tailscale","Tailscale","Tailscale GUI")
          s = m:section(TypedSection,"tailscale","è®¾ç½®")
          s.anonymous = true
          s:option(Flag,"enabled","å¯ç”¨")
          ak = s:option(Value,"authkey","AuthKey")
          ak.password = true
          s:option(Flag,"accept_routes","æŽ¥å—è·¯ç”±")
          btn = s:option(Button,"apply","åº”ç”¨")
          btn.inputstyle = "apply"
          function btn.write()
              sys.call("/etc/init.d/tailscale start")
              sys.call("tailscale up --accept-routes")
          end
          return m
          EOF

          # install.sh
          cat > x86_64/install.sh << 'EOF'
          #!/bin/sh
          cp -r ./* /
          /etc/init.d/tailscale enable
          /etc/init.d/tailscale start
          echo "Tailscale GUI installed"
          EOF
          chmod +x x86_64/install.sh

      - name: ðŸ“¦ æ‰“åŒ… run
        run: |
          mkdir -p output
          makeself x86_64 output/tailscale-gui_x86_64.run \
            "Tailscale GUI Installer" ./install.sh

      - name: ðŸ“¤ ä¸Šä¼  run
        uses: actions/upload-artifact@v4
        with:
          name: tailscale-gui
          path: output/*.run
