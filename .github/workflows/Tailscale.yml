name: Build Tailscale Run File

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Create staging directories
        run: |
          mkdir -p staging/bin
          mkdir -p staging/www/cgi-bin
          mkdir -p staging/usr/lib/lua/luci/controller
          mkdir -p staging/usr/lib/lua/luci/view/tailscale_web

      - name: Copy files to staging
        run: |
          cp -f bin/tailscale* staging/bin/
          cp -f www/cgi-bin/tailscale_api staging/www/cgi-bin/
          cp -f usr/lib/lua/luci/controller/tailscale_web.lua staging/usr/lib/lua/luci/controller/
          cp -f usr/lib/lua/luci/view/tailscale_web/index.htm staging/usr/lib/lua/luci/view/tailscale_web/

      - name: Set permissions
        run: |
          chmod +x staging/bin/tailscale*
          chmod 755 staging/www/cgi-bin/tailscale_api

      - name: Create Backend API (修改后，去掉 --reset)
        run: |
          cat << 'EOF' > staging/www/cgi-bin/tailscale_api
          #!/bin/sh
          echo "Content-type: application/json"
          echo ""
          TS="/bin/tailscale"
          case "$QUERY_STRING" in
              *action=status*)
                  ST=$($TS status --json 2>/dev/null)
                  ACTIVE=$(echo "$ST" | jq -r '.BackendState // "未运行"')
                  if [ "$ACTIVE" != "Running" ]; then
                      URL=$($TS up --accept-dns=false 2>&1 | grep -o 'https://login.tailscale.com/a/[^ ]*')
                      echo "{\"active\": \"未登录\", \"url\": \"$URL\", \"devices\": []}"
                  else
                      IP=$(echo "$ST" | jq -r '.Self.TailscaleIPs[0] // "-"')
                      DEVICES=$(echo "$ST" | jq -c '.Peer | to_entries | map({hostname: .value.HostName, ip: (.value.TailscaleIPs[0] // "-"), online: .value.Online})')
                      echo "{\"active\": \"运行中\", \"ip\": \"$IP\", \"devices\": $DEVICES}"
                  fi ;;
              *action=logout*) $TS logout >/dev/null 2>&1; echo "{\"result\": \"ok\"}" ;;
          esac
          EOF

      - name: Build .run file
        run: |
          tar -C staging -cf tailscale.run .
