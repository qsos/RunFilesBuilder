name: Build Tailscale .run (Fix GUI)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Tailscale Version (留空则自动获取最新)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y makeself jq curl

      - name: Determine Version
        id: meta
        run: |
          if [ -z "${{ inputs.version }}" ]; then
            TAG=$(curl -sL https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r ".tag_name")
            VERSION=${TAG#v}
          else
            VERSION=${{ inputs.version }}
          fi
          echo "Target Version: $VERSION"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download Official Static Binaries
        run: |
          VERSION=${{ steps.meta.outputs.version }}
          # 下载官方 amd64 静态包
          DOWNLOAD_URL="https://pkgs.tailscale.com/stable/tailscale_${VERSION}_amd64.tgz"
          curl -fSL "$DOWNLOAD_URL" -o tailscale.tgz
          tar xzf tailscale.tgz
          
          mkdir -p staging/bin
          EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "tailscale_*_amd64" | head -n 1)
          mv "$EXTRACTED_DIR/tailscale" staging/bin/
          mv "$EXTRACTED_DIR/tailscaled" staging/bin/
          rm -f tailscale.tgz
          rm -rf "$EXTRACTED_DIR"

      - name: Prepare LuCI App (GUI)
        run: |
          mkdir -p staging/pkgs
          
          # 优先检查仓库 shell 目录下是否有自定义 ipk
          if [ -f "shell/luci-app-tailscale.ipk" ]; then
            echo "Using local IPK from repository..."
            cp shell/luci-app-tailscale.ipk staging/pkgs/luci-app-tailscale.ipk
          else
            echo "Downloading generic OpenWrt LuCI app..."
            # 使用 OpenWrt 22.03 的官方包，兼容性较好 (iStoreOS 基于 21/22)
            # 注意：如果这个链接失效，脚本会自动创建一个空文件避免报错，但在路由器上就不会有界面
            curl -L -o staging/pkgs/luci-app-tailscale.ipk https://downloads.openwrt.org/releases/packages-22.03/x86_64/packages/luci-app-tailscale_1.1.1-1_all.ipk
          fi

      - name: Generate Install Script
        run: |
          # 生成安装脚本
          cat << 'EOF' > staging/install.sh
          #!/bin/sh
          
          echo ">>> 1. Installing Tailscale Binaries..."
          cp -f bin/tailscale /usr/sbin/tailscale
          cp -f bin/tailscaled /usr/sbin/tailscaled
          chmod +x /usr/sbin/tailscale /usr/sbin/tailscaled
          
          echo ">>> 2. Installing LuCI Interface..."
          if [ -f pkgs/luci-app-tailscale.ipk ]; then
              # 关键修复：添加 --nodeps 忽略依赖检查，因为我们是手动复制的二进制
              opkg install pkgs/luci-app-tailscale.ipk --nodeps --force-reinstall
              
              # 关键修复：如果安装失败（比如 opkg 报错），尝试强行解压安装
              if [ $? -ne 0 ]; then
                  echo "Warning: opkg install failed, trying manual extraction..."
                  tar xzf pkgs/luci-app-tailscale.ipk -C /tmp/
                  tar xzf /tmp/data.tar.gz -C /
                  rm -f /tmp/data.tar.gz /tmp/control.tar.gz /tmp/debian-binary
              fi
          else
              echo "Error: LuCI IPK file missing!"
          fi
          
          echo ">>> 3. Refreshing Menu & Services..."
          # 关键修复：清除 LuCI 缓存，否则菜单不显示
          rm -rf /tmp/luci-indexcache
          rm -rf /tmp/luci-modulecache/
          
          # 重启相关服务
          /etc/init.d/rpcd restart
          
          # 尝试启用并启动 Tailscale
          if [ -f /etc/init.d/tailscale ]; then
              /etc/init.d/tailscale enable
              /etc/init.d/tailscale restart
          fi
          
          echo "==============================================="
          echo "   Installation Complete! "
          echo "   Please refresh your browser page."
          echo "   Look under 'Network' -> 'Tailscale' or 'VPN'"
          echo "==============================================="
          EOF
          
          chmod +x staging/install.sh

      - name: Build .run Package
        run: |
          VERSION=${{ steps.meta.outputs.version }}
          makeself --notemp staging tailscale-${VERSION}.run "Tailscale ${VERSION} Installer" ./install.sh

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ steps.meta.outputs.version }}-fixed"
          name: "Tailscale v${{ steps.meta.outputs.version }} (GUI Fixed)"
          files: tailscale-${{ steps.meta.outputs.version }}.run
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
