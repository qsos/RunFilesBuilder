name: Build Tailscale .run (x86 & arm64 + Simple GUI)

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Tailscale Version (ç•™ç©ºè‡ªåŠ¨æœ€æ–°)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    # å®šä¹‰çŸ©é˜µç­–ç•¥ï¼šåŒæ—¶æ„å»º x86 å’Œ arm64
    strategy:
      fail-fast: false
      matrix:
        include:
          # --- x86 ä»»åŠ¡é…ç½® ---
          - arch: amd64             # å®˜æ–¹ä¸‹è½½ç”¨çš„æ¶æ„å
            output_name: x86        # æœ€ç»ˆæ–‡ä»¶åæ˜¾ç¤ºåç§°
            
          # --- ARM64 ä»»åŠ¡é…ç½® ---
          - arch: arm64             # å®˜æ–¹ä¸‹è½½ç”¨çš„æ¶æ„å
            output_name: arm64      # æœ€ç»ˆæ–‡ä»¶åæ˜¾ç¤ºåç§°

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y makeself jq curl

      - name: Determine Version
        id: meta
        run: |
          if [ -z "${{ inputs.version }}" ]; then
            TAG=$(curl -sL https://api.github.com/repos/tailscale/tailscale/releases/latest | jq -r ".tag_name")
            VERSION=${TAG#v}
          else
            VERSION=${{ inputs.version }}
          fi
          echo "Building for: ${{ matrix.output_name }}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Download Official Binaries
        run: |
          VERSION=${{ steps.meta.outputs.version }}
          DL_ARCH=${{ matrix.arch }}
          
          echo "Downloading Tailscale v$VERSION for $DL_ARCH..."
          curl -fSL "https://pkgs.tailscale.com/stable/tailscale_${VERSION}_${DL_ARCH}.tgz" -o tailscale.tgz
          tar xzf tailscale.tgz
          
          # å‡†å¤‡æ‰“åŒ…ç›®å½•ç»“æ„
          mkdir -p staging/bin
          mkdir -p staging/usr/lib/lua/luci/controller/
          mkdir -p staging/usr/lib/lua/luci/view/tailscale_web/
          
          # æå–äºŒè¿›åˆ¶æ–‡ä»¶
          EXTRACTED_DIR=$(find . -maxdepth 1 -type d -name "tailscale_*_${DL_ARCH}" | head -n 1)
          mv "$EXTRACTED_DIR/tailscale" staging/bin/
          mv "$EXTRACTED_DIR/tailscaled" staging/bin/
          rm -f tailscale.tgz
          rm -rf "$EXTRACTED_DIR"

      # === å…³é”®æ–°æ­¥éª¤ï¼šåŠ¨æ€ç”Ÿæˆç®€æ˜“è·³è½¬ç•Œé¢ ===
      - name: Generate Simple LuCI Redirector
        run: |
          # 1. ç”Ÿæˆæ§åˆ¶å™¨æ–‡ä»¶ (å®šä¹‰èœå•å…¥å£)
          # è¿™ä¼šå°†èœå•æ”¾åœ¨ "æœåŠ¡" -> "Tailscale Web" ä¸‹
          cat << 'EOF' > staging/usr/lib/lua/luci/controller/tailscale_web.lua
          module("luci.controller.tailscale_web", package.seeall)
          function index()
               entry({"admin", "services", "tailscale_web"}, template("tailscale_web/index"), _("Tailscale Web"), 99).dependent = false
          end
          EOF

          # 2. ç”Ÿæˆè¯•å›¾æ¨¡æ¿æ–‡ä»¶ (HTMLè·³è½¬é¡µé¢)
          # è¿™æ®µä»£ç ä¼šè‡ªåŠ¨è·å–è·¯ç”±å™¨çš„LANå£IPï¼Œå¹¶ç”Ÿæˆè·³è½¬æŒ‰é’®
          cat << 'EOF' > staging/usr/lib/lua/luci/view/tailscale_web/index.htm
          <%+header%>
          <div class="cbi-map">
          <h2 name="content">Tailscale Web ç®¡ç†</h2>
          <div class="cbi-section-descr">
              Tailscale å†…ç½® Web ç®¡ç†ç•Œé¢å·²åœ¨åå°è¿è¡Œã€‚<br/>
              ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å°†åœ¨æ–°çª—å£ä¸­æ‰“å¼€å®Œæ•´çš„å®˜æ–¹ç®¡ç†é¡µé¢ã€‚
          </div>
          <fieldset class="cbi-section">
              <%
                  -- è·å– LAN å£ IP ç”¨äºæ„å»ºè·³è½¬é“¾æ¥ï¼Œå¦‚æœè·å–å¤±è´¥åˆ™å°è¯•ç”¨ä¸»æœºå
                  local uci = require "luci.model.uci".cursor()
                  local lan_ip = uci:get("network", "lan", "ipaddr") or window.location.hostname
                  local web_url = "http://" .. lan_ip .. ":5252"
              %>
              <div style="text-align: center; margin: 30px 0;">
                  <!-- ä½¿ç”¨ JavaScript æ‰“å¼€æ–°çª—å£è·³è½¬åˆ° 5252 ç«¯å£ -->
                  <input type="button" class="cbi-button cbi-button-apply important"
                         style="font-size: 1.3em; padding: 15px 40px; cursor: pointer;"
                         value="ğŸ‘‰ æ‰“å¼€ Tailscale Web ç®¡ç†ç•Œé¢ ğŸ‘ˆ"
                         onclick="window.open('<%=web_url%>', '_blank'); return false;" />
                  <br/><br/><br/>
                  <small style="color: #888;">ç›®æ ‡åœ°å€: <a href="<%=web_url%>" target="_blank"><%=web_url%></a></small>
              </div>
          </fieldset>
          </div>
          <%+footer%>
          EOF

      - name: Generate Install Script
        run: |
          # ç”Ÿæˆå®‰è£…è„šæœ¬
          cat << 'EOF' > staging/install.sh
          #!/bin/sh
          
          echo ">>> 1. Installing Core Binaries..."
          cp -f bin/tailscale /usr/sbin/tailscale
          cp -f bin/tailscaled /usr/sbin/tailscaled
          chmod +x /usr/sbin/tailscale /usr/sbin/tailscaled
          
          echo ">>> 2. Installing Simple GUI Redirector..."
          # ç›´æ¥å¤åˆ¶æ„å»ºå¥½çš„ LuCI æ–‡ä»¶åˆ°ç³»ç»Ÿç›®å½•
          cp -rf usr/* /usr/
          
          echo ">>> 3. Configuring System & Boot..."
          if [ ! -f /etc/config/tailscale ]; then touch /etc/config/tailscale; fi
          
          # è®¾ç½®å¼€æœºè‡ªåŠ¨å¯åŠ¨ Web UI (é‡è¦ï¼šç¡®ä¿è·³è½¬è¿‡å»æœ‰ä¸œè¥¿æ˜¾ç¤º)
          # å…ˆæ¸…ç†æ—§é…ç½®
          sed -i '/tailscale web/d' /etc/rc.local
          # æ’å…¥æ–°é…ç½®åˆ° exit 0 ä¹‹å‰
          sed -i '/exit 0/i /usr/sbin/tailscale web --listen=0.0.0.0:5252 > /dev/null 2>&1 &' /etc/rc.local
          # ç«‹å³è¿è¡Œä¸€æ¬¡
          /usr/sbin/tailscale web --listen=0.0.0.0:5252 > /dev/null 2>&1 &
          
          # æ¸…ç† LuCI ç¼“å­˜ (ç¡®ä¿èœå•ç«‹å³æ˜¾ç¤º)
          rm -rf /tmp/luci-indexcache
          rm -rf /tmp/luci-modulecache/
          
          # åˆ›å»ºæ ‡å‡†æœåŠ¡å¯åŠ¨è„šæœ¬ï¼ˆç¡®ä¿å†…æ ¸è¿è¡Œï¼‰
          cat << 'EOF_SVC' > /etc/init.d/tailscale
          #!/bin/sh /etc/rc.common
          START=99
          STOP=01
          USE_PROCD=1
          start_service() {
              mkdir -p /etc/tailscale /var/run/tailscale
              procd_open_instance
              procd_set_param command /usr/sbin/tailscaled
              procd_set_param args --state=/etc/tailscale/tailscaled.state --socket=/var/run/tailscale/tailscaled.sock --port=41641
              procd_set_param respawn
              procd_set_param stdout 1
              procd_set_param stderr 1
              procd_close_instance
          }
          EOF_SVC
          chmod +x /etc/init.d/tailscale
          /etc/init.d/tailscale enable
          /etc/init.d/tailscale restart
          
          echo "======================================================="
          echo "âœ… å®‰è£…å®Œæˆï¼"
          echo "è¯·æŒ‰ Ctrl+F5 å¼ºåˆ¶åˆ·æ–°æµè§ˆå™¨é¡µé¢ã€‚"
          echo "å…¥å£ä½ç½®ï¼šæœåŠ¡ (Services) -> Tailscale Web"
          echo "======================================================="
          EOF
          chmod +x staging/install.sh

      - name: Build .run Package
        run: |
          VERSION=${{ steps.meta.outputs.version }}
          OUT_NAME=${{ matrix.output_name }}
          makeself --notemp staging tailscale-${VERSION}-${OUT_NAME}.run "Tailscale ${VERSION} (${OUT_NAME}) Installer" ./install.sh

      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: "v${{ steps.meta.outputs.version }}-redirect"
          name: "Tailscale v${{ steps.meta.outputs.version }} (With Web Redirect)"
          files: tailscale-${{ steps.meta.outputs.version }}-${{ matrix.output_name }}.run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
