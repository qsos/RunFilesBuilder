- name: Create Backend API
        run: |
          cat << 'EOF' > staging/www/cgi-bin/tailscale_api
          #!/bin/sh
          echo "Content-type: application/json"
          echo ""
          TS="/bin/tailscale"
          case "$QUERY_STRING" in
              *action=status*)
                  # å¢åŠ  2 ç§’è¶…æ—¶ï¼Œé˜²æ­¢ç½‘é¡µæ­»é”
                  ST=$(timeout 2 $TS status --json 2>/dev/null)
                  STATE=$(echo "$ST" | jq -r '.BackendState // "æœªè¿è¡Œ"')
                  if [ "$STATE" != "Running" ]; then
                      # å¼‚æ­¥è·å– URLï¼Œå¦‚æœ 3 ç§’æ‹¿ä¸åˆ°å°±è¿”å›ç©ºï¼Œè®©ç½‘é¡µç¨åé‡è¯•
                      URL=$(timeout 3 $TS up --accept-dns=false --reset 2>&1 | grep -o 'https://login.tailscale.com/a/[^ ]*' | head -n 1)
                      echo "{\"active\": \"æœªç™»å½•\", \"url\": \"$URL\", \"devices\": []}"
                  else
                      IP=$(echo "$ST" | jq -r '.Self.TailscaleIPs[0] // "-"')
                      DEVICES=$(echo "$ST" | jq -c '.Peer | to_entries | map({hostname: .value.HostName, ip: (.value.TailscaleIPs[0] // "-"), online: .value.Online})')
                      echo "{\"active\": \"è¿è¡Œä¸­\", \"ip\": \"$IP\", \"devices\": $DEVICES}"
                  fi ;;
              *action=logout*) $TS logout >/dev/null 2>&1; echo "{\"result\": \"ok\"}" ;;
          esac
          EOF
          chmod 755 staging/www/cgi-bin/tailscale_api

      - name: Create UI
        run: |
          cat << 'EOF' > staging/usr/lib/lua/luci/view/tailscale_web/index.htm
          <%+header%>
          <div class="cbi-map">
              <h2 style="margin-bottom:20px">Tailscale æ§åˆ¶é¢æ¿</h2>
              
              <div id="auth-box" style="display:none; background:#fffbe6; padding:20px; border:1px solid #ffe58f; border-radius:4px; margin-bottom:20px; text-align:center;">
                  <strong style="color:#856404; font-size:16px;">âš ï¸ éœ€è¦æˆæƒç™»å½•</strong>
                  <p id="auth-msg" style="margin:10px 0;">æ­£åœ¨ç”Ÿæˆæˆæƒé“¾æ¥ï¼Œè¯·ç¨å€™...</p>
                  <a id="auth-btn" href="#" target="_blank" style="display:none; padding:12px 24px; background:#1890ff; color:#fff; border-radius:4px; text-decoration:none; font-weight:bold;">ğŸ‘‰ ç‚¹å‡»å‰å¾€å®˜ç½‘æˆæƒ ğŸ‘ˆ</a>
              </div>

              <div style="background:#fff; padding:15px; border:1px solid #ddd; border-radius:4px; margin-bottom:20px; display:flex; justify-content:space-between; align-items:center;">
                  <div><strong>æœåŠ¡çŠ¶æ€:</strong> <span id="st-txt">åˆå§‹åŒ–...</span><br><small id="ip-txt" style="color:#888">åœ°å€: -</small></div>
                  <button class="cbi-button cbi-button-reset" onclick="doLogout()">é‡ç½®æœåŠ¡</button>
              </div>

              <table class="cbi-section-table" style="width:100%; table-layout:fixed; border:1px solid #eee;">
                  <thead><tr class="cbi-section-table-titles"><th class="cbi-section-table-cell" style="width:40%; text-align:left; padding:10px;">è®¾å¤‡åç§°</th><th class="cbi-section-table-cell" style="width:35%; text-align:left; padding:10px;">å†…ç½‘ IP</th><th class="cbi-section-table-cell" style="width:25%; text-align:left; padding:10px;">çŠ¶æ€</th></tr></thead>
                  <tbody id="dev-list"></tbody>
              </table>
          </div>

          <script>
              function doLogout() {
                  if(confirm('ç¡®å®šè¦é‡ç½®å¹¶æ³¨é”€å—ï¼Ÿ')) {
                      fetch('/cgi-bin/tailscale_api?action=logout').then(() => location.reload());
                  }
              }

              function refresh() {
                  fetch('/cgi-bin/tailscale_api?action=status')
                  .then(r => r.json())
                  .then(d => {
                      const st = document.getElementById('st-txt');
                      const abox = document.getElementById('auth-box');
                      const amsg = document.getElementById('auth-msg');
                      const abtn = document.getElementById('auth-btn');
                      
                      st.innerText = d.active;
                      st.style.color = (d.active === "è¿è¡Œä¸­") ? "#28a745" : "#ff4d4f";
                      document.getElementById('ip-txt').innerText = "åœ°å€: " + (d.ip || "-");

                      if (d.active === "æœªç™»å½•") {
                          abox.style.display = 'block';
                          if (d.url) {
                              abtn.href = d.url;
                              abtn.style.display = 'inline-block';
                              amsg.innerText = "æˆæƒé“¾æ¥å·²å°±ç»ªï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å®Œæˆç™»å½•ï¼š";
                          } else {
                              abtn.style.display = 'none';
                              amsg.innerText = "æ­£åœ¨è·å–æœ€æ–°æˆæƒé“¾æ¥ï¼Œè¯·ç¨ç­‰ (çº¦5-10ç§’)...";
                          }
                      } else {
                          abox.style.display = 'none';
                      }

                      let h = '';
                      if(d.devices && d.devices.length > 0) {
                          d.devices.forEach(v => {
                              h += '<tr class="cbi-section-table-row"><td style="padding:10px;"><strong>'+v.hostname+'</strong></td><td style="padding:10px;"><code>'+v.ip+'</code></td><td style="padding:10px;">'+(v.online ? '<span style="color:#28a745">â— åœ¨çº¿</span>' : '<span style="color:#999">â—‹ ç¦»çº¿</span>')+'</td></tr>';
                          });
                      } else { h = '<tr><td colspan="3" style="text-align:center;padding:20px;color:#999;">'+(d.active === "è¿è¡Œä¸­" ? "å½“å‰è´¦å·ä¸‹æš‚æ— å…¶ä»–èŠ‚ç‚¹" : "ç­‰å¾…ç™»å½•å®Œæˆåæ˜¾ç¤ºåˆ—è¡¨")+'</td></tr>'; }
                      document.getElementById('dev-list').innerHTML = h;
                  })
                  .catch(e => {
                      document.getElementById('st-txt').innerText = "API å“åº”ç¼“æ…¢ï¼Œé‡è¯•ä¸­...";
                  });
              }
              refresh(); setInterval(refresh, 5000);
          </script>
          <%+footer%>
          EOF
