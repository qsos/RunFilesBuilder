name: Make Tailscale Community GUI run

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üì¶ Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y makeself curl

      - name: ‚¨áÔ∏è Download tailscale core
        run: |
          mkdir -p x86_64
          curl -L https://pkgs.tailscale.com/stable/tailscale_1.92.1_amd64.tgz -o tailscale.tgz
          tar zxvf tailscale.tgz
          cp tailscale_*/tailscale x86_64/
          cp tailscale_*/tailscaled x86_64/

      - name: ‚¨áÔ∏è Download LuCI GUI ipk
        run: |
          cd x86_64
          curl -L https://dl.openwrt.ai/packages-24.10/x86_64/kiddin9/luci-app-tailscale-community_26.341.56069~77a6686_all.ipk \
            -o luci-app-tailscale-community.ipk

      - name: üìã Copy install script
        run: |
          cp shell/install-tailscale.sh x86_64/install.sh
          chmod +x x86_64/install.sh

      - name: üì¶ Build run file
        run: |
          mkdir -p output
          makeself x86_64 \
            output/tailscale-community-x86_64.run \
            "Tailscale Community GUI Installer (x86_64)" \
            ./install.sh

      - name: üì§ Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "tailscale-community"
          name: "tailscale-community"
          files: output/*.run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
