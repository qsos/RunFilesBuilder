name: turboacc-final-build

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install Makeself
        run: |
          sudo apt-get update
          sudo apt-get install -y makeself

      - name: Prepare Files
        run: |
          chmod +x shell/turboacc.sh
          ./shell/turboacc.sh
          # 使用 info 里的说明作为控制文件
          cp info/turboacc.md control

      - name: Create .run Package
        run: |
          mkdir -p output
          # 制作自解压包，固定文件名
          makeself --nox11 . output/TurboAcc_For_iStoreOS_x86.run "TurboAcc_Network_Accelerator" ./install.sh

      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: final
          name: TurboAcc 终极修复版
          body: |
            这是最后一次尝试的构建包。
            包含：LuCI 界面、修改版 Firewall4、FullCone 内核补丁。
            适配：iStoreOS x86_64
          files: output/TurboAcc_For_iStoreOS_x86.run
          overwrite: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
