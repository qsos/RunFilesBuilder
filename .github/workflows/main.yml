name: Build PassWall RUN

on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Clone RunFilesBuilder
        run: |
          git clone https://github.com/wukongdaily/RunFilesBuilder.git

      - name: Prepare RUN structure
        run: |
          mkdir -p RunFilesBuilder/x86_64/files

          # 写入 ps_install.sh（不依赖你仓库原文件）
          cat > RunFilesBuilder/x86_64/files/ps_install.sh << 'EOF'
          #!/bin/sh

          echo "=== PassWall Install Script ==="

          # 添加 key
          wget -O /tmp/passwall.pub https://master.dl.sourceforge.net/project/openwrt-passwall-build/passwall.pub
          opkg-key add /tmp/passwall.pub

          # 读取系统信息
          . /etc/openwrt_release
          release=${DISTRIB_RELEASE%.*}
          arch=$DISTRIB_ARCH

          # 写入 feed
          cat >> /etc/opkg/customfeeds.conf << FEED
          src/gz passwall_luci https://master.dl.sourceforge.net/project/openwrt-passwall-build/releases/packages-$release/$arch/passwall_luci
          src/gz passwall_packages https://master.dl.sourceforge.net/project/openwrt-passwall-build/releases/packages-$release/$arch/passwall_packages
          FEED

          opkg update
          opkg install luci-app-passwall luci-i18n-passwall-zh-cn

          /etc/init.d/uhttpd restart

          echo "=== PassWall Install Finished ==="
          EOF

          chmod +x RunFilesBuilder/x86_64/files/ps_install.sh

      - name: Build RUN file
        run: |
          cd RunFilesBuilder
          bash RunFilesBuilder.sh x86_64

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: passwall-run
          path: RunFilesBuilder/output/*.run
