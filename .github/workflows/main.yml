name: Build Passwall for iStoreOS (Final)

on:
  schedule:
    - cron: '0 18 * * 5'  # 每周五北京时间凌晨2点运行
  workflow_dispatch:      # 允许手动点击运行

permissions:
  contents: write

jobs:
  download_and_package:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          # x86_64 (常见软路由)
          - arch: x86_64
            base_url: https://master.dl.sourceforge.net/project/openwrt-passwall-build/releases/packages-23.05/x86_64
            
          # ARMv8 (R2S, R4S, RK3568 等)
          - arch: aarch64_cortex-a53
            base_url: https://master.dl.sourceforge.net/project/openwrt-passwall-build/releases/packages-23.05/aarch64_cortex-a53

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # 1. 修复报错：安装 requests 库
      - name: Install Python dependencies
        run: pip install requests

      - name: Clone makeself
        run: git clone https://github.com/megastep/makeself.git

      - name: 下载 Passwall 及所有依赖
        env:
          BASE_URL: ${{ matrix.base_url }}
          ARCH: ${{ matrix.arch }}
        run: |
          mkdir -p passwall_${ARCH}/packages
          
          # Python 脚本：自动解析源并下载所有 IPK
          cat <<EOF > downloader.py
          import requests
          import os
          import gzip
          
          sub_dirs = ['passwall_packages', 'passwall_luci']
          base_url = os.environ['BASE_URL']
          target_dir = f"passwall_{os.environ['ARCH']}/packages"

          print(f"Start downloading from {base_url}...")
          headers = {'User-Agent': 'Mozilla/5.0'}

          for sub in sub_dirs:
              index_url = f"{base_url}/{sub}/Packages.gz"
              print(f"Fetching index: {index_url}")
              try:
                  r = requests.get(index_url, headers=headers, timeout=30)
                  r.raise_for_status()
                  
                  # 解压索引
                  content = gzip.decompress(r.content).decode('utf-8', errors='ignore')
                  
                  for line in content.split('\n'):
                      if line.startswith('Filename:'):
                          filename = line.split(': ')[1].strip()
                          file_url = f"{base_url}/{sub}/{filename}"
                          local_path = os.path.join(target_dir, filename)
                          
                          if not os.path.exists(local_path):
                              print(f"Downloading: {filename}")
                              try:
                                  fr = requests.get(file_url, headers=headers, stream=True, timeout=60)
                                  if fr.status_code == 200:
                                      with open(local_path, 'wb') as f:
                                          for chunk in fr.iter_content(chunk_size=8192):
                                              f.write(chunk)
                                  else:
                                      print(f"Failed: {fr.status_code}")
                              except Exception as e:
                                  print(f"Error: {e}")

              except Exception as e:
                  print(f"Index fetch failed: {e}")

          print("Download finished.")
          EOF
          
          python3 downloader.py

      - name: 创建安装脚本 (install.sh)
        run: |
          cd passwall_${{ matrix.arch }}
          
          # 针对 iStoreOS 优化的安装脚本
          cat <<EOF > install.sh
          #!/bin/sh
          echo "Installing Passwall for iStoreOS..."
          
          if [ -d "./packages" ]; then
              cd packages
          else
              echo "Package directory not found!"
              exit 1
          fi

          echo "Installing IPKs..."
          # 关键参数：--force-depends 解决 iStoreOS 内核版本差异问题
          opkg install *.ipk --force-depends --force-overwrite
          
          if [ \$? -eq 0 ]; then
              echo "Success! Please refresh your web interface."
              rm -rf /tmp/passwall_install
          else
              echo "Installation finished with warnings (normal for iStoreOS)."
          fi
          EOF
          
          chmod +x install.sh

      - name: 制作 .run 文件
        run: |
          cd makeself
          OUT_NAME="Passwall_iStoreOS_${{ matrix.arch }}_$(date +'%Y%m%d').run"
          ./makeself.sh ../passwall_${{ matrix.arch }}/ $OUT_NAME "Passwall for iStoreOS" ./install.sh
          
          mkdir -p ../output
          mv $OUT_NAME ../output/

      - name: 上传 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: passwall_${{ matrix.arch }}
          path: output/*.run

  release:
    needs: download_and_package
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true 
      
      # 2. 修复报错：先计算变量，再使用
      - name: Generate Tag & Date
        run: |
          echo "RELEASE_TAG=iStoreOS-Build-$(date +'%Y.%m.%d')" >> $GITHUB_ENV
          echo "RELEASE_DATE=$(date +'%Y.%m.%d')" >> $GITHUB_ENV

      - name: 发布 Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          name: "Passwall for iStoreOS (ybfl源) ${{ env.RELEASE_DATE }}"
          body: |
            Passwall 离线安装包 - 专为 iStoreOS 优化
            
            **包含架构：**
            - `x86_64`: 适用于常见的英特尔/AMD 软路由。
            - `aarch64`: 适用于 R2S, R4S, R68s, RK3568 等 ARM 设备。
            
            **安装说明：**
            1. 下载对应的 `.run` 文件。
            2. 上传到路由器 `/tmp` 目录。
            3. 执行命令：`chmod +x 文件名.run && ./文件名.run`
            
            *数据来源: sourceforge.net/projects/openwrt-passwall-build*
          files: artifacts/*.run
