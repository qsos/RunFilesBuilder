name: Make Passwall run files (Optimized)

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch latest release tag
        id: fetch_info
        run: |
          # è®¾å®šæ–°çš„å®˜æ–¹åœ°å€
          REPO="Openwrt-Passwall/openwrt-passwall"
          LATEST_TAG=$(curl -s "https://api.github.com/repos/$REPO/releases/latest" | jq -r .tag_name)
          echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_ENV
          echo "REPO=$REPO" >> $GITHUB_ENV

      - name: Download Passwall Assets
        run: |
          mkdir -p downloads
          # ç²¾å‡†è·å–åŒ…å« x86_64, aarch64 å’Œ luci çš„ä¸‹è½½é“¾æ¥
          ASSETS=$(curl -s "https://api.github.com/repos/${{ env.REPO }}/releases/latest" | jq -r '.assets[].browser_download_url')
          for url in $ASSETS; do
            if [[ "$url" == *"x86_64.zip"* ]]; then
              curl -L -o downloads/x86_64.zip "$url"
            elif [[ "$url" == *"aarch64_cortex-a53.zip"* ]]; then
              curl -L -o downloads/aarch64.zip "$url"
            elif [[ "$url" == *"luci-"*".ipk"* ]]; then
              curl -L -o "downloads/$(basename $url)" "$url"
            fi
          done

      - name: Setup Makeself
        run: |
          git clone --depth 1 https://github.com/megastep/makeself.git
          sudo cp makeself/makeself.sh /usr/local/bin/

      - name: Create Self-Extracting Packages
        run: |
          platforms=("x86_64" "aarch64")
          for arch in "${platforms[@]}"; do
            mkdir -p "pkg_$arch/ipks"
            unzip "downloads/$arch.zip" -d "pkg_$arch/ipks/"
            cp downloads/luci-*.ipk "pkg_$arch/ipks/"
            
            # --- å…³é”®ä¿®æ”¹ï¼šæ ¹æ®æ–°çš„å®‰è£…æ–¹å¼ç¼–å†™ install.sh ---
            cat <<EOF > "pkg_$arch/install.sh"
#!/bin/sh
echo "--- Starting Passwall New Installation Mode ---"

# 1. æ›´æ–°è½¯ä»¶æº
opkg update

# 2. å¤„ç† dnsmasq å†²çª (è¿™æ˜¯æ–°ç‰ˆå®‰è£…æœ€æ ¸å¿ƒçš„æ­¥éª¤)
if opkg list-installed | grep -q "^dnsmasq -"; then
    echo "Removing old dnsmasq to avoid conflict..."
    opkg remove dnsmasq --force-depends
fi

# 3. å®‰è£…æ ¸å¿ƒä¾èµ–ç¯å¢ƒ (é€‚é…æ–°ç‰ˆ nftables/iptables)
echo "Installing core dependencies..."
opkg install dnsmasq-full
opkg install kmod-nft-tproxy kmod-nft-socket kmod-nft-iprange 2>/dev/null || echo "Notice: Some kmods might be built-in."

# 4. å®‰è£…æ‰€æœ‰ä¸‹è½½çš„ ipk åŒ…
echo "Installing Passwall packages..."
opkg install ipks/*.ipk --force-reinstall --force-maintainer

# 5. æ¸…ç†ç¼“å­˜
rm -rf /tmp/luci-modulecache/ /tmp/luci-indexcache
echo "Installation completed. Please refresh your LuCI web interface."
EOF
            chmod +x "pkg_$arch/install.sh"
            
            # ä½¿ç”¨ makeself æ‰“åŒ…
            makeself.sh "pkg_$arch" "passwall_${arch}_${{ env.LATEST_TAG }}.run" "Passwall Installer by Github Action" ./install.sh
          done

      - name: Prepare Release Notes
        run: |
          echo "### ğŸ“¦ Passwall ${{ env.LATEST_TAG }} è‡ªåŠ¨é›†æˆåŒ…" > release.md
          echo "- **æ¥æº**: [Openwrt-Passwall](${{ env.REPO }})" >> release.md
          echo "- **æ¶æ„**: x86_64, aarch64_cortex-a53" >> release.md
          echo "- **å®‰è£…æ–¹æ³•**: åœ¨ç»ˆç«¯è¿è¡Œ \`sh passwall_xxx.run\` å³å¯" >> release.md
          echo -e "\n**åŸç‰ˆæ›´æ–°æ—¥å¿—:**\n" >> release.md
          curl -s "https://api.github.com/repos/${{ env.REPO }}/releases/latest" | jq -r .body >> release.md

      - name: Upload and Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.LATEST_TAG }}
          name: "PassWall-${{ env.LATEST_TAG }}"
          body_path: release.md
          files: "*.run"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
