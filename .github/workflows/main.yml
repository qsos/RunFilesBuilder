name: Build Passwall for iStoreOS (Fixed)

on:
  schedule:
    - cron: '0 18 * * 5'
  workflow_dispatch:

jobs:
  download_and_package:
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - arch: x86_64
            base_url: https://master.dl.sourceforge.net/project/openwrt-passwall-build/releases/packages-23.05/x86_64
            
          - arch: aarch64_cortex-a53
            base_url: https://master.dl.sourceforge.net/project/openwrt-passwall-build/releases/packages-23.05/aarch64_cortex-a53

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      # --- 关键修复：添加这一步来安装 requests 库 ---
      - name: Install Python dependencies
        run: pip install requests
      # -------------------------------------------

      - name: Clone makeself
        run: git clone https://github.com/megastep/makeself.git

      - name: 下载 Passwall 及所有依赖
        env:
          BASE_URL: ${{ matrix.base_url }}
          ARCH: ${{ matrix.arch }}
        run: |
          mkdir -p passwall_${ARCH}/packages
          
          # 这是一个 Python 脚本，用于从 SourceForge 抓取所有 IPK
          cat <<EOF > downloader.py
          import requests
          import os
          import gzip
          
          sub_dirs = ['passwall_packages', 'passwall_luci']
          base_url = os.environ['BASE_URL']
          target_dir = f"passwall_{os.environ['ARCH']}/packages"

          print(f"Start downloading from {base_url}...")

          # 设置 User-Agent 防止被 SourceForge 拦截
          headers = {'User-Agent': 'Mozilla/5.0'}

          for sub in sub_dirs:
              index_url = f"{base_url}/{sub}/Packages.gz"
              print(f"Fetching index: {index_url}")
              try:
                  r = requests.get(index_url, headers=headers, timeout=30)
                  r.raise_for_status()
                  
                  content = gzip.decompress(r.content).decode('utf-8')
                  
                  for line in content.split('\n'):
                      if line.startswith('Filename:'):
                          filename = line.split(': ')[1].strip()
                          # 构造完整下载地址
                          file_url = f"{base_url}/{sub}/{filename}"
                          local_path = os.path.join(target_dir, filename)
                          
                          if not os.path.exists(local_path):
                              print(f"Downloading: {filename}")
                              try:
                                  fr = requests.get(file_url, headers=headers, stream=True, timeout=60)
                                  if fr.status_code == 200:
                                      with open(local_path, 'wb') as f:
                                          for chunk in fr.iter_content(chunk_size=8192):
                                              f.write(chunk)
                                  else:
                                      print(f"Failed to download {filename}: Status {fr.status_code}")
                              except Exception as e:
                                  print(f"Error downloading {filename}: {e}")

              except Exception as e:
                  print(f"Failed to fetch index for {sub}: {e}")

          print("Download finished.")
          EOF
          
          python3 downloader.py

      - name: 创建安装脚本 (install.sh)
        run: |
          cd passwall_${{ matrix.arch }}
          
          cat <<EOF > install.sh
          #!/bin/sh
          echo "Installing Passwall for iStoreOS..."
          
          if [ -d "./packages" ]; then
              cd packages
          else
              echo "Package directory not found!"
              exit 1
          fi

          echo "Installing IPKs..."
          opkg install *.ipk --force-depends --force-overwrite
          
          if [ \$? -eq 0 ]; then
              echo "Success! Please refresh your web interface."
          else
              echo "Installation finished with warnings (normal for iStoreOS)."
          fi
          EOF
          
          chmod +x install.sh

      - name: 制作 .run 文件
        run: |
          cd makeself
          OUT_NAME="Passwall_iStoreOS_${{ matrix.arch }}_$(date +'%Y%m%d').run"
          ./makeself.sh ../passwall_${{ matrix.arch }}/ $OUT_NAME "Passwall for iStoreOS" ./install.sh
          
          mkdir -p ../output
          mv $OUT_NAME ../output/

      - name: 上传 Artifact
        uses: actions/upload-artifact@v4
        with:
          name: passwall_${{ matrix.arch }}
          path: output/*.run

  release:
    needs: download_and_package
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true 
          
      - name: 发布 Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: "iStoreOS-Build-$(date +'%Y.%m.%d')"
          name: "Passwall for iStoreOS (ybfl源) $(date +'%Y.%m.%d')"
          files: artifacts/*.run
